/* 学包分子 维尼梗有害 nmslese##dream 灭共助推器 老街 彩色哥 XDD 塔西佗陷阱 习是春绿 红旗下的蛋 赛禁评 习是春竹 中字头组长 CoronaXi 习三点 朝令夕改 重地之战 武汉委托李克强 习后主 万岁来武汉了 甩锅侠 冲塔 花花公子 人民领袖 赵弹 世宗 袭包皮 亲自指挥 央视姓党 法习斯 大撒幣 毛进平 彩色熊 巴拿马文件 假.."~bang！卒 “皇帝梦” 外交习语 共哀宗 云视察 庆丰帝的千秋梦 习近平光辉形象 邪大大 习奥塞斯库、齐奥塞斯库 截颈平 禁评大帝 蹄防 virus##king 秦城监狱 普习金 次级乳包 民进党 独彩者 毛泽东2.0 shuu##kinn##pei 傻大头 习总输记 习厉王 白猪 毛装 氼兲嫑炛 习二二（二零二零年五月二十二日开二会） 习式病毒 vop “登机”（与登基同音） 称帝修宪 近言 送礼平 习病法 墨索里习 习付 中国拉清单工作领导小组组长 大大品牌 末代皇帝 bingbang帝 岿然不动 叩谢习恩 V尼哥 毛魔转世 黄俄 总加速师 习武帝 动森 专治各种不服 发皇帝梦 枪毙名单 颐使气指 西朝鲜人民自治岛 武统时代 包惠帝 平&强 习语录 号尿壶公 独裁国贼 这个年很静 习屎黄 孢 袁世凯第二 疫情蔓延 不知名氏 维尼熊 习大帝 普近 乳制品 习犬犬 太祖兔 动物庄园 狙击手布阵 退党 腊肉馅儿包子 习张三丰 shit##hole##bing##fa 习公奭 核平全世界 习和谐 皇帝亲临忠诚的武汉 习澳塞斯库 口罩外交 主席+终身制 習大佬 匪酋习维尼 最后领导人 刁近乎 习尔布特 帝皇頌 䒒(tiáo)菦(qín)苹(píng) 大撒币 阳台上的哨兵 玉习大帝 平话 孙笑川 吸精瓶 习得梁家书卷 悉包皮 法外狂徒Lucy（德国） 习尿瓶 习废帝 足球外交 现任匪首 糟糕皇帝 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 文明其精神 习驴 书单吟诵者 食腐虫 韦来书记 刁二婚 《生物安全法》 屎進瓶 人尽皆知的体育迷 席近平 冰棒外交 不强自息 孤独的毒王 毛近平 厕所革命 刁人13 十里山路不换肩 庆丰废物 习下台 习特勒 维持会长 梦帝 武当七侠的政治斗争 时间控制 小习微信 皇帝梦 NMSL 纳翠党 卡近菲 五毛主席 维尼之声 “梦回大清” 富平学霸刁斤干 习匪 添宪宝宝 吸包皮 习条英机 席子兵法 疯狂宇宙大帝 隔离”的金葫芦 非洲大撒币 屎侯 天安门合法继承人 头号球迷 总书记来过我的家 金科律玉 屎禁评 官僚主义 200吨 习##卡##巴##卡 习大犬 东瘟疫之地统治者暨全境守护者 庆丰包·勃列日涅夫 维尼史 习king 系包皮 中国特色射秽煮疫制度 庆丰称帝 满脸喷粪 指定接班人 二百斤 九大诉求 二次袁、袁世凯二世、袁二 御板泽民 近日成 习低能儿 人类命运共同体首席架构师 WHO的君王 昆明湖涨潮 10号跳跳虎被维尼拉清单 习包子 习习蛤蛤 祈翠 习索里尼 冠子兵法 习包子 主席贺词 A##Big##Deal Adolf##Xitler 尊蛤讨包 386系统驱动游戏 大国造疫 叼斤干 XD 感恩教育 习包子的Fa 九评 2020全面小康 Chairman##Xi 撒币宝 习贼 习夶 第一书记王沪宁 大大招牌 萨格尔王 小学博士 捐麦子 野心习 晚共昏君 十日文革 动物森友会 刁远山 修宪帝 恩重如删 万岁来武汉 习一尊 “习泽东”和“洪宪”（袁世凯的帝号） 习梦思 智商不重要 迈克尔·索伊 维尼大帝 习大林 国贼习近平 当皇帝的小丑 野兽先辈 骑巨龙 习梦撕 维尼挂彩 习曱甴 口罩大会 万岁 影子末帝 亲自考察 乳包文化 人民战争 猪禁评 親自視頻 细颈瓶 习二胖 川普的朋友or敌人 禁评封号 electron8964 彭主席（习主席走了太太接班） 国王 习奥赛斯库 习歪嘴 做N届的主席 习皇帝 毛孙 读稿机 老歪脖子树 断崖式下跌 战疫国 劝进 坡涛汹涌 习思想 北红尾鸲 领袖习澡水 習敗敗 “登基” 修宪 哲欣 中国离岸隐匿资产管理工作领导小组组组长 疯狂宇宙包 洗尽贫 包经 维尼·屎(Winnie##the##Poo) 人均接近八千万 集金币 喜包皮 720事件 包包大人 平平 闹得欢 shit禁评 阿平 讨习檄文 Heil##Xitler 世界最强乞丐 中国首席造梦大师 “无罩”现身 读书单 习进棺 毛二习 习远凸 “复辟” 甴近平 抗麦套装 沼气专家 赵家家仆 没规划的葬礼 总统包子习 包大人 習敗北 习二蛋 喷粪帝 习时代 毛二世 冤大头 独裁者 役民五术 包皇 宽衣帝 无限连任 动物之森 不敢高声语 战“疫”金句 习宽衣 尼哥 包包侠 习壳郎 习正日 崇祯 裹嘎举吸钢闸门 清零宗、清零帝 亲自指挥疫情 习家军 共哀宗 北京中南海支部书记 电脑世代586 中国离岸隐匿资产管理工作领导小组组组长 近身平A 习兵法 乳透社##小反旗 中国爱非洲 习流氓 The##Xi##Factor（习近平因素） 号屎洞 支那毒王 倒车 包子病毒 初二圣君 习殡法 修宪连任 SB包子 二百五大帝 shit侯 集金pay 习大 连专家也为之叹服的电脑天才 Cicada##3301##XD 信女愿一生吃素 惜包皮 坡涛汹涌 拉清单 习总 宰相 包子露宪 坟头蹦迪 形式主义防疫 新影帝 集近闭 青年大学包 戴口赵 恩维尔·霍习 刁斤山 阿道夫-习 习梦死 每日祈翠 头上三尺有神明 清单帝 皇帝的新衣 糖尿维尼 叩谢习恩 儿童习典 习三拍 习达姆 习核心 赵王 第22条军规 两会期间+隐瞒 倒车斯基 瘟疫领主习近平 维尼连任 粪坑先生 习皇的新装 粪坑兵法 洗包皮 维尼熊给跳跳虎黄牌 Criminal##Xi##"Xitler"##Jinping 瘟疫降生习近平 习大乞 习蛤 爱新觉罗近平 学包积极分子 当代秦始皇 維尼頌 野兽主席 毛二 没有网络安全就没有国家安全 禁评的理由 宽衣大帝 鞋哥 超邓赶毛 颐指气使 习像章 红二代 公车上书 人民领袖 刁后主 习猪头 习二坐船 通商宽衣 背书单 耀眼黄红黄 通商宽衣 习背书 十一郎习近平 赵人13 一天游泳一千米 视频看望 习老八 任志强 习包皮 甴种 习瘟猪 Voice##of##Pooh 格萨尔 维稳警察（O） 半羽习近平 梦回大清 习Core “黄袍加身” 大锅瞻遗 那翠化 总书记来我家 扛麦郎 小学居士 Corona##Xi（习病毒） 戏博士 习猪下台 习奥塞斯库 习emperor 维尼写史 xdd 20000T麦子 当代秦二世 中国的新皇帝 嬉包皮 习狍 墙内人 亲自封号 刁斤二 习“甩锅” 习匪帝 习呆呆 细瓶颈 学包率 习言乱语 亲自脱贫 狙击手待命 刁人13 支那精神野爹 维尼DISCO 习语 ChinaXi 游泳一千米 刁大犬 梁家河贵族 习王的田野上 包子金刚腿 狙击手待命 维尼带货 任大炮 倒车帝 黑白翠 刁近猴 大兔 皇帝亲临忠诚的武汉 恐惊天上人 包子兵法 追思焦裕禄 习二卒 习禁评 吃赵弹 疯狂宇宙 灰习牛 nmslman（习主席） 习躲躲 习卒习 大海掀翻小池塘 习尽贫 清华毕业 夶 64岁 扛麦帝 仲夏夜之中国梦 戏包皮 维尼快乐组织（Winnie##Happy##Organization）简称WHO 親自蒞臨 慨撒大帝 习博士 习教父 蔡英文最强助选 赵付 习近砰 梁家河 习大郎 习包子 腊肉包 裸宽包子劾心 刁二将 习二世胡亥 日子像蜜甜 习孢子 家业论 维尼警察（X） 我是一个足球迷 习卒 错误执行者 包禁评 终身领导人 嘻包皮 习侯 胡志平 祈翠語言包 Mr##Shithole 爱新觉罗·近平 东方project 亲自删评 百万雄师事件 字共狗 习猪席 野蛮其体魄 包子宪法 相信有神论的物理学博士 崇祯帝 一带一路 基拉大和习近平 贬词包用 不同意的举手##没有##没有 4中组长 刁槑夶尛 习太孑 羽日帝 翡翠娘娘 神明论 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 包帝巡游 你是反贼吗 */
package com.pcdd.sonovel.merge;


import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.file.FileAppender;
import com.pcdd.sonovel.util.FileUtils;
import lombok.SneakyThrows;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.RepeatedTest;

import java.io.*;
import java.nio.ByteBuffer;
import java.nio.MappedByteBuffer;
import java.nio.channels.FileChannel;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.util.List;

/**
 * 测试结论：多线程无法提高 I/O 密集型任务的性能（epub 章节的添加、多个 txt 合并）
 *
 * @author pcdd
 * Created at 2024/12/8
 */

class TxtMergerTest {

    // static File dir = FileUtil.file("e:/Temp/small_dir");
    static File dir = FileUtil.file("d:/Temp/small_dir");
    static File outputFile = FileUtil.file("e:/Temp/Merge.txt");

    @RepeatedTest(1)
    @DisplayName("首次执行速度最慢，73 s")
    void test01() {
        FileAppender appender = new FileAppender(outputFile, 16, true);
        for (File item : FileUtils.sortFilesByName(dir)) {
            System.out.println(item.getName());
            appender.append(FileUtil.readUtf8String(item));
        }
        appender.flush();
    }

    @RepeatedTest(1)
    @SneakyThrows
    void test02() {
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(outputFile, StandardCharsets.UTF_8, true))) {
            for (File item : FileUtils.sortFilesByName(dir)) {
                System.out.println(item.getName());
                try (BufferedReader reader = new BufferedReader(new FileReader(item, StandardCharsets.UTF_8))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        writer.write(line);
                        writer.newLine();
                    }
                }
                writer.newLine();
            }
        }
    }

    @RepeatedTest(1)
    @SneakyThrows
    @DisplayName("test02 的优化")
    void test03() {
        List<File> files = FileUtils.sortFilesByName(dir);
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(outputFile, StandardCharsets.UTF_8, true), 16 * 1024)) {
            for (File item : files) {
                System.out.println("Processing: " + item.getName());
                try (BufferedReader reader = new BufferedReader(new FileReader(item, StandardCharsets.UTF_8), 16 * 1024)) {
                    char[] buffer = new char[16 * 1024]; // 缓冲数组
                    int len;
                    while ((len = reader.read(buffer)) != -1) {
                        writer.write(buffer, 0, len);
                    }
                }
                writer.newLine(); // 文件之间添加换行符
            }
        }
    }

    @RepeatedTest(1)
    @DisplayName("NIO 13.905 s")
    @SneakyThrows
    void test04() {
        List<File> files = FileUtils.sortFilesByName(dir);
        Path outputPath = Paths.get(outputFile.getAbsolutePath());
        try (BufferedWriter writer = Files.newBufferedWriter(outputPath, StandardCharsets.UTF_8, StandardOpenOption.CREATE, StandardOpenOption.APPEND)) {
            for (File item : files) {
                System.out.println("Processing: " + item.getName());
                Files.lines(item.toPath(), StandardCharsets.UTF_8).forEach(line -> {
                    try {
                        writer.write(line);
                        writer.newLine();
                    } catch (IOException e) {
                        throw new UncheckedIOException(e);
                    }
                });
                writer.newLine();
            }
        }
    }

    @RepeatedTest(1)
    @DisplayName("FileChannel 11.107 s")
    @SneakyThrows
    void test05() {
        List<File> files = FileUtils.sortFilesByName(dir);
        try (FileChannel outChannel = FileChannel.open(Paths.get(outputFile.getAbsolutePath()), StandardOpenOption.CREATE, StandardOpenOption.WRITE, StandardOpenOption.APPEND)) {
            for (File file : files) {
                System.out.println("Processing: " + file.getName());
                try (FileChannel inChannel = FileChannel.open(file.toPath(), StandardOpenOption.READ)) {
                    long size = inChannel.size();
                    MappedByteBuffer buffer = inChannel.map(FileChannel.MapMode.READ_ONLY, 0, size);
                    outChannel.write(buffer);
                }
                outChannel.write(ByteBuffer.wrap(System.lineSeparator().getBytes(StandardCharsets.UTF_8))); // 换行符
            }
        }
    }

}