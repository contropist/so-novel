/* 灰习牛 习梦死 “登机”（与登基同音） 人均接近八千万 习核心 狙击手待命 习和谐 刁二婚 动物森友会 梁家河 习二胖 新影帝 习下台 毛魔转世 学包积极分子 维尼快乐组织（Winnie##Happy##Organization）简称WHO 包帝巡游 习emperor 墙内人 席近平 习病法 梦帝 主席+终身制 10号跳跳虎被维尼拉清单 习大 戴口赵 包大人 宽衣帝 人尽皆知的体育迷 爱新觉罗近平 习大林 修宪连任 刁斤二 神明论 西朝鲜人民自治岛 Corona##Xi（习病毒） 晚共昏君 法习斯 亲自考察 习屎黄 亲自封号 白猪 东方project 第一书记王沪宁 毛孙 墨索里习 习远凸 维尼写史 维尼带货 法外狂徒Lucy（德国） 头上三尺有神明 甴种 戏博士 习二坐船 维稳警察（O） 包禁评 720事件 基拉大和习近平 金科律玉 习##卡##巴##卡 皇帝的新衣 习梦撕 不知名氏 SB包子 动物庄园 习大郎 维尼挂彩 世界最强乞丐 清零宗、清零帝 习三点 夶 “复辟” 袁世凯第二 扛麦帝 习卒习 The##Xi##Factor（习近平因素） 大撒幣 大国造疫 维尼·屎(Winnie##the##Poo) 粪坑先生 习达姆 喜包皮 猪禁评 皇帝亲临忠诚的武汉 细颈瓶 近日成 习大帝 骑巨龙 包皇 习king “习泽东”和“洪宪”（袁世凯的帝号） 满脸喷粪 十里山路不换肩 习大乞 战“疫”金句 赵王 学包分子 傻大头 冠子兵法 重地之战 刁槑夶尛 役民五术 玉习大帝 无限连任 文明其精神 xdd “梦回大清” 北京中南海支部书记 系包皮 习是春竹 阳台上的哨兵 独裁者 糖尿维尼 V尼哥 枪毙名单 云视察 读书单 习一尊 赵人13 包子金刚腿 平话 追思焦裕禄 集近闭 毛近平 爱新觉罗·近平 这个年很静 彩色熊 二次袁、袁世凯二世、袁二 做N届的主席 集金pay 你是反贼吗 百万雄师事件 总加速师 叩谢习恩 WHO的君王 皇帝亲临忠诚的武汉 野蛮其体魄 习澳塞斯库 vop 一带一路 卡近菲 习尔布特 最后领导人 不强自息 糟糕皇帝 习包子的Fa 外交习语 当代秦二世 闹得欢 习厉王 家业论 独裁国贼 近言 习孢子 亲自脱贫 习猪下台 书单吟诵者 亲自指挥 大撒币 习蛤 习三拍 洗包皮 那翠化 Cicada##3301##XD 厕所革命 習敗敗 退党 食腐虫 包包侠 尊蛤讨包 包子宪法 刁近乎 核平全世界 习语录 习瘟猪 倒车帝 口罩大会 親自蒞臨 共哀宗 讨习檄文 包子露宪 乳制品 裹嘎举吸钢闸门 足球外交 刁斤山 公车上书 现任匪首 花花公子 64岁 终身领导人 习进棺 东瘟疫之地统治者暨全境守护者 截颈平 大兔 抗麦套装 号尿壶公 昆明湖涨潮 老歪脖子树 习猪头 瘟疫降生习近平 慨撒大帝 天安门合法继承人 邪大大 维尼DISCO 羽日帝 平&强 孤独的毒王 习言乱语 维尼史 赵弹 连专家也为之叹服的电脑天才 红旗下的蛋 刁大犬 习贼 习包子 习卒 习匪帝 中国特色射秽煮疫制度 习思想 信女愿一生吃素 习废帝 坟头蹦迪 386系统驱动游戏 庆丰废物 习老八 习总输记 拉清单 疯狂宇宙包 动物之森 皇帝梦 影子末帝 嬉包皮 喷粪帝 习武帝 䒒(tiáo)菦(qín)苹(píng) nmslese##dream 御板泽民 毛二世 人民领袖 清华毕业 恩维尔·霍习 习二卒 时间控制 学包率 次级乳包 万岁来武汉了 小习微信 孢 乳透社##小反旗 匪酋习维尼 习近平光辉形象 刁人13 “无罩”现身 习特勒 动森 4中组长 习“甩锅” 萨格尔王 包子病毒 十一郎习近平 维尼熊给跳跳虎黄牌 习宽衣 习太孑 蔡英文最强助选 中国爱非洲 世宗 “黄袍加身” 超邓赶毛 维持会长 半羽习近平 维尼梗有害 习侯 通商宽衣 背书单 习夶 习禁评 习家军 梦回大清 习流氓 主席贺词 2020全面小康 二百五大帝 习二二（二零二零年五月二十二日开二会） 习正日 “登基” 20000T麦子 毛二习 刁后主 維尼頌 nmslman（习主席） 习Core Mr##Shithole 庆丰称帝 独彩者 领袖习澡水 禁评封号 毛装 万岁来武汉 virus##king 秦城监狱 红二代 冲塔 祈翠語言包 习包子 总书记来我家 贬词包用 格萨尔 共哀宗 Heil##Xitler 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 Criminal##Xi##"Xitler"##Jinping 习时代 每日祈翠 习驴 庆丰包·勃列日涅夫 支那毒王 习猪席 A##Big##Deal 毛进平 赵家家仆 专治各种不服 习匪 末代皇帝 腊肉包 shit侯 指定接班人 黄俄 习近砰 中国离岸隐匿资产管理工作领导小组组组长 习索里尼 狙击手待命 习殡法 读稿机 我是一个足球迷 感恩教育 近身平A 叩谢习恩 瘟疫领主习近平 習敗北 总书记来过我的家 习得梁家书卷 NMSL 裸宽包子劾心 没规划的葬礼 央视姓党 武统时代 一天游泳一千米 撒币宝 哲欣 青年大学包 添宪宝宝 大大品牌 bingbang帝 不敢高声语 阿平 禁评大帝 富平学霸刁斤干 口罩外交 electron8964 恩重如删 人类命运共同体首席架构师 颐指气使 形式主义防疫 包惠帝 习尿瓶 颐使气指 包子兵法 叼斤干 禁评的理由 吃赵弹 普习金 疯狂宇宙大帝 刁人13 宰相 屎侯 习语 倒车 袭包皮 纳翠党 习狍 XD 习总 悉包皮 习背书 鞋哥 庆丰帝的千秋梦 吸包皮 习曱甴 屎禁评 亲自指挥疫情 中国离岸隐匿资产管理工作领导小组组组长 十日文革 习躲躲 北红尾鸲 甩锅侠 不同意的举手##没有##没有 习皇的新装 日子像蜜甜 大海掀翻小池塘 智商不重要 初二圣君 送礼平 游泳一千米 习犬犬 习尽贫 错误执行者 Voice##of##Pooh 习壳郎 电脑世代586 劝进 倒车斯基 宽衣大帝 Chairman##Xi 洗尽贫 老街 儿童习典 shit禁评 梁家河贵族 习包皮 屎進瓶 嘻包皮 习大犬 岿然不动 耀眼黄红黄 大大招牌 称帝修宪 彭主席（习主席走了太太接班） 疫情蔓延 维尼连任 腊肉馅儿包子 孙笑川 习兵法 断崖式下跌 粪坑兵法 包经 普近 川普的朋友or敌人 灭共助推器 习后主 九评 大锅瞻遗 毛泽东2.0 清单帝 捐麦子 崇祯帝 头号球迷 二百斤 shit##hole##bing##fa 中国的新皇帝 习奥塞斯库 朝令夕改 细瓶颈 武当七侠的政治斗争 人民战争 习付 习习蛤蛤 修宪帝 习王的田野上 维尼大帝 民进党 当皇帝的小丑 狙击手布阵 习歪嘴 XDD 彩色哥 甴近平 习奥塞斯库、齐奥塞斯库 总统包子习 尼哥 两会期间+隐瞒 习博士 字共狗 shuu##kinn##pei 习二蛋 野兽先辈 坡涛汹涌 习低能儿 武汉委托李克强 习教父 五毛主席 疯狂宇宙 包包大人 中国首席造梦大师 韦来书记 小学居士 相信有神论的物理学博士 战疫国 冤大头 恐惊天上人 修宪 中字头组长 Adolf##Xitler 隔离”的金葫芦 当代秦始皇 巴拿马文件 200吨 集金币 崇祯 阿道夫-习 习式病毒 习是春绿 小学博士 习梦思 习二世胡亥 扛麦郎 刁二将 ChinaXi 习张三丰 中国拉清单工作领导小组组长 帝皇頌 野兽主席 冰棒外交 维尼熊 非洲大撒币 习皇帝 黑白翠 习呆呆 沼气专家 发皇帝梦 翡翠娘娘 祈翠 视频看望 维尼之声 官僚主义 塔西佗陷阱 号屎洞 任大炮 第22条军规 习像章 惜包皮 刁近猴 氼兲嫑炛 席子兵法 赵付 太祖兔 胡志平 蹄防 野心习 习奥赛斯库 假.."~bang！卒 乳包文化 亲自删评 九大诉求 支那精神野爹 仲夏夜之中国梦 习公奭 没有网络安全就没有国家安全 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 坡涛汹涌 CoronaXi 迈克尔·索伊 平平 人民领袖 刁远山 親自視頻 毛二 《生物安全法》 任志强 通商宽衣 万岁 戏包皮 习条英机 “皇帝梦” 習大佬 维尼警察（X） 国贼习近平 吸精瓶 习包子 赛禁评 国王 */
package com.pcdd.sonovel.source;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.json.JSONUtil;
import cn.hutool.log.dialect.console.ConsoleLog;
import cn.hutool.log.level.Level;
import com.pcdd.sonovel.convert.ChapterConverter;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.*;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.TestInstance;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.CsvSource;

import java.util.List;

/**
 * @author pcdd
 * Created at 2024/12/28
 */
// 保证测试类实例在多个测试方法间共享
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class BookSourceTest {

    private static final AppConfig config = ConfigUtils.config();
    public static final String DIVIDER = "=".repeat(50);
    private String bookUrl;
    private String chapterUrl;

    static {
        JsoupUtils.trustAllSSL();
        ConsoleLog.setLevel(Level.OFF);
        // 覆盖默认配置
        config.setLanguage("zh_CN");
        config.setExtName("txt");
        config.setThreads(-1);
    }

    @DisplayName("测试直连书源")
    @ParameterizedTest
    @CsvSource({
            "1, http://www.xbiqugu.la/130/130509/",
            "2, https://www.shuhaige.net/199178/",
            "3, http://www.mcmssc.la/145_145199/",
            "4, http://www.99xs.info/tag/129_129843/",
            "5, https://www.tianxibook.com/book/94376180/",
            "8, https://www.dxmwx.org/book/56441.html",
            "9, https://www.22biqu.com/biqu79148/",
            "10, http://www.xbiquzw.net/10_10233/",
            "11, https://www.0xs.net/txt/68398.html",
            "13, https://www.xbqg06.com/1582/",
            "14, https://www.luegeng.com/book186856/",
            "15, https://www.96dushu.com/book/344921/",
            "17, http://www.81zwwww.com/90_90170/",
            "18, http://www.ujxsw.net/book/107612/",
    })
    void testDirectSources(int sourceId, String bookUrl) {
        this.bookUrl = bookUrl;
        config.setSourceId(sourceId);

        searchParse("辰东");
        bookParse();
        tocParse();
        chapterParse();
    }

    @DisplayName("测试代理书源")
    @ParameterizedTest
    @CsvSource({
            "6, https://quanben5.com/n/xinghedadi/",
            "7, https://www.69shuba.com/book/48273.htm",
            "12, https://www.deqixs.com/xiaoshuo/106/",
            "16, https://www.sudugu.com/1012/",
    })
    void testProxySources(int sourceId, String bookUrl) {
        this.bookUrl = bookUrl;
        config.setSourceId(sourceId);

        searchParse("辰东");
        bookParse();
        tocParse();
        chapterParse();
    }

    public void searchParse(String keyword) {
        Console.log("\n{} START searchParse {}", DIVIDER, DIVIDER);
        List<SearchResult> list;
        if (config.getSourceId() == 6) {
            list = new SearchParser6(config).parse(keyword);
        } else {
            list = new SearchParser(config).parse(keyword, true);
        }
        if (CollUtil.isEmpty(list)) {
            Console.log("\"{}\"搜索结果为空", keyword);
        }
        if (!list.isEmpty()) {
            Console.log("点击此 URL 确保首条搜索结果访问有效: {}", CollUtil.getFirst(list).getUrl());
        }
        new SearchParser(config).printSearchResult(list);
        Console.log("{} END searchParse {}\n", DIVIDER, DIVIDER);
    }

    public void bookParse() {
        Console.log("\n{} START bookParse {}", DIVIDER, DIVIDER);
        Book book = new BookParser(config).parse(bookUrl);
        Console.log(JSONUtil.toJsonPrettyStr(book));
        Console.log("{} END bookParse {}\n", DIVIDER, DIVIDER);
    }

    public void tocParse() {
        Console.log("\n{} START tocParse {}", DIVIDER, DIVIDER);
        TocParser tocParser = new TocParser(config);
        List<Chapter> toc = tocParser.parse(bookUrl);
        toc.forEach(System.out::println);
        if (CollUtil.isNotEmpty(toc)) {
            // 测试目录首章
            chapterUrl = toc.get(0).getUrl();
        } else {
            Console.log("目录为空");
        }
        Console.log("{} END tocParse {}\n", DIVIDER, DIVIDER);
    }

    public void chapterParse() {
        Console.log("\n{} START chapterParse {}", DIVIDER, DIVIDER);
        Chapter chapter = Chapter.builder().url(chapterUrl).build();
        Chapter beforeFiltration = new ChapterParser(config).parse(chapter);
        Chapter afterFiltration = new ChapterConverter(config).convert(beforeFiltration);
        Source source = new Source(config.getSourceId());
        ChineseConverter.convert(afterFiltration, source.rule.getLanguage(), config.getLanguage());
        Console.log(afterFiltration.getContent());
        Console.log("{} END chapterParse {}\n", DIVIDER, DIVIDER);
    }

}