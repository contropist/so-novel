/* 人民领袖 灭共助推器 书单吟诵者 甴种 坡涛汹涌 一带一路 十里山路不换肩 屎侯 习包子的Fa 刁人13 习犬犬 庆丰帝的千秋梦 习时代 世宗 喜包皮 亲自指挥 SB包子 口罩外交 习二胖 灰习牛 宽衣大帝 红旗下的蛋 国王 集近闭 野心习 习三拍 糟糕皇帝 大海掀翻小池塘 武统时代 蔡英文最强助选 每日祈翠 彩色熊 习一尊 习核心 清单帝 The##Xi##Factor（习近平因素） 塔西佗陷阱 劝进 人民领袖 号尿壶公 粪坑兵法 中字头组长 抗麦套装 甴近平 习夶 习壳郎 习二坐船 习皇帝 红二代 A##Big##Deal 习兵法 十一郎习近平 独裁者 electron8964 赵家家仆 法习斯 喷粪帝 习梦撕 习卒 冰棒外交 不知名氏 秦城监狱 赵王 老街 字共狗 大大招牌 学包率 末代皇帝 动物庄园 习猪下台 包包侠 枪毙名单 维尼·屎(Winnie##the##Poo) 皇帝亲临忠诚的武汉 你是反贼吗 䒒(tiáo)菦(qín)苹(píng) 近日成 Corona##Xi（习病毒） 半羽习近平 迈克尔·索伊 称帝修宪 习后主 习梦死 宰相 核平全世界 ChinaXi 阿平 万岁来武汉了 夶 习远凸 乳包文化 总书记来我家 共哀宗 平&强 习老八 《生物安全法》 影子末帝 CoronaXi 第22条军规 亲自指挥疫情 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 满脸喷粪 20000T麦子 习条英机 戏博士 中国爱非洲 赵人13 通商宽衣 沼气专家 吸精瓶 裸宽包子劾心 修宪连任 习大乞 包禁评 阳台上的哨兵 习曱甴 总统包子习 Voice##of##Pooh 武汉委托李克强 叩谢习恩 无限连任 现任匪首 九大诉求 禁评封号 毛二习 屎進瓶 孙笑川 国贼习近平 感恩教育 习大郎 习近砰 shit禁评 超邓赶毛 当代秦二世 扛麦郎 近身平A 洗包皮 老歪脖子树 电脑世代586 野兽主席 刁远山 包包大人 virus##king NMSL 大大品牌 任志强 万岁 4中组长 皇帝梦 背书单 彩色哥 习思想 nmslman（习主席） 视频看望 习“甩锅” V尼哥 翡翠娘娘 包子病毒 花花公子 世界最强乞丐 基拉大和习近平 发皇帝梦 时间控制 假.."~bang！卒 人民战争 习侯 习式病毒 岿然不动 共哀宗 维尼带货 10号跳跳虎被维尼拉清单 刁槑夶尛 庆丰包·勃列日涅夫 习呆呆 刁近猴 羽日帝 习太孑 外交习语 集金币 毛二 相信有神论的物理学博士 任大炮 吸包皮 亲自删评 中国离岸隐匿资产管理工作领导小组组组长 梁家河 智商不重要 匪酋习维尼 习king “无罩”现身 戴口赵 “皇帝梦” 读书单 毛进平 祈翠語言包 习王的田野上 讨习檄文 “黄袍加身” 修宪 大兔 爱新觉罗近平 号屎洞 坡涛汹涌 xdd 颐使气指 习梦思 孤独的毒王 祈翠 习近平光辉形象 习Core 720事件 二次袁、袁世凯二世、袁二 习二世胡亥 习达姆 坟头蹦迪 袁世凯第二 北京中南海支部书记 200吨 腊肉包 冤大头 习二蛋 习大犬 贬词包用 Criminal##Xi##"Xitler"##Jinping 神明论 初二圣君 甩锅侠 梁家河贵族 小习微信 皇帝的新衣 習敗北 习猪席 习特勒 玉习大帝 习尽贫 阿道夫-习 独裁国贼 疫情蔓延 包大人 習大佬 支那精神野爹 大撒幣 习皇的新装 黄俄 习歪嘴 尼哥 耀眼黄红黄 习卒习 天安门合法继承人 野蛮其体魄 连专家也为之叹服的电脑天才 屎禁评 刁大犬 腊肉馅儿包子 拉清单 Mr##Shithole 公车上书 习病法 氼兲嫑炛 包帝巡游 习包子 扛麦帝 赵付 专治各种不服 没规划的葬礼 动森 “梦回大清” 文明其精神 战“疫”金句 XDD 修宪帝 云视察 习贼 退党 习三点 西朝鲜人民自治岛 毛二世 习宽衣 两会期间+隐瞒 习躲躲 普近 习殡法 维尼DISCO 格萨尔 东方project 错误执行者 平话 做N届的主席 信女愿一生吃素 普习金 习教父 刁二将 习下台 维尼史 维尼写史 狙击手待命 包子金刚腿 亲自封号 习习蛤蛤 维尼之声 习博士 傻大头 习总 胡志平 宽衣帝 小学博士 梦帝 习进棺 包惠帝 万岁来武汉 习公奭 刁近乎 “登机”（与登基同音） 维尼连任 闹得欢 野兽先辈 平平 习驴 习匪帝 役民五术 动物之森 人类命运共同体首席架构师 川普的朋友or敌人 中国的新皇帝 刁斤二 维尼大帝 不强自息 昆明湖涨潮 洗尽贫 习总输记 习澳塞斯库 慨撒大帝 悉包皮 习匪 vop 九评 “登基” 习猪头 捐麦子 系包皮 习二二（二零二零年五月二十二日开二会） 彭主席（习主席走了太太接班） 親自視頻 戏包皮 金科律玉 親自蒞臨 央视姓党 毛泽东2.0 疯狂宇宙 大国造疫 维稳警察（O） 哲欣 终身领导人 维尼快乐组织（Winnie##Happy##Organization）简称WHO 粪坑先生 孢 习包子 清零宗、清零帝 维持会长 冲塔 习低能儿 日子像蜜甜 叼斤干 习二卒 bingbang帝 晚共昏君 叩谢习恩 隔离”的金葫芦 富平学霸刁斤干 亲自脱贫 皇帝亲临忠诚的武汉 赵弹 北红尾鸲 足球外交 不敢高声语 颐指气使 习尿瓶 狙击手布阵 形式主义防疫 习废帝 倒车帝 一天游泳一千米 断崖式下跌 习是春绿 蹄防 口罩大会 赛禁评 疯狂宇宙包 学包分子 二百五大帝 游泳一千米 细瓶颈 “习泽东”和“洪宪”（袁世凯的帝号） 食腐虫 截颈平 习张三丰 萨格尔王 青年大学包 邪大大 裹嘎举吸钢闸门 禁评的理由 新影帝 墙内人 刁人13 倒车斯基 人均接近八千万 乳透社##小反旗 百万雄师事件 Cicada##3301##XD 禁评大帝 习emperor 指定接班人 总加速师 习家军 习大 XD 习言乱语 冠子兵法 习大帝 恐惊天上人 习是春竹 我是一个足球迷 主席贺词 瘟疫降生习近平 吃赵弹 习背书 习屎黄 总书记来过我的家 糖尿维尼 五毛主席 习语录 习武帝 独彩者 Adolf##Xitler 太祖兔 瘟疫领主习近平 卡近菲 习大林 疯狂宇宙大帝 習敗敗 习禁评 shit侯 习包皮 维尼熊给跳跳虎黄牌 民进党 不同意的举手##没有##没有 维尼梗有害 支那毒王 习流氓 韦来书记 习像章 习付 中国离岸隐匿资产管理工作领导小组组组长 shuu##kinn##pei 嬉包皮 Heil##Xitler 中国首席造梦大师 亲自考察 大锅瞻遗 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 维尼挂彩 习奥塞斯库、齐奥塞斯库 大撒币 崇祯帝 习和谐 习狍 法外狂徒Lucy（德国） 乳制品 通商宽衣 习包子 倒车 Chairman##Xi 领袖习澡水 官僚主义 维尼警察（X） 习厉王 纳翠党 恩维尔·霍习 追思焦裕禄 白猪 人尽皆知的体育迷 2020全面小康 习瘟猪 帝皇頌 nmslese##dream 动物森友会 黑白翠 維尼頌 包皇 习孢子 席子兵法 最后领导人 巴拿马文件 猪禁评 包子露宪 毛近平 shit##hole##bing##fa 习尔布特 狙击手待命 恩重如删 添宪宝宝 没有网络安全就没有国家安全 毛装 战疫国 送礼平 习正日 爱新觉罗·近平 包经 习蛤 包子宪法 那翠化 包子兵法 习得梁家书卷 庆丰称帝 席近平 维尼熊 习##卡##巴##卡 十日文革 头号球迷 “复辟” 习语 小学居士 崇祯 惜包皮 袭包皮 中国特色射秽煮疫制度 家业论 次级乳包 64岁 集金pay 刁二婚 东瘟疫之地统治者暨全境守护者 读稿机 毛魔转世 学包积极分子 重地之战 第一书记王沪宁 细颈瓶 386系统驱动游戏 御板泽民 这个年很静 刁后主 当代秦始皇 庆丰废物 习奥塞斯库 撒币宝 刁斤山 中国拉清单工作领导小组组长 武当七侠的政治斗争 二百斤 非洲大撒币 习奥赛斯库 厕所革命 尊蛤讨包 清华毕业 鞋哥 习索里尼 WHO的君王 近言 墨索里习 嘻包皮 当皇帝的小丑 主席+终身制 骑巨龙 头上三尺有神明 梦回大清 仲夏夜之中国梦 毛孙 儿童习典 朝令夕改 */
package com.pcdd.sonovel.source;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.date.DatePattern;
import cn.hutool.core.date.DateTime;
import cn.hutool.core.lang.Console;
import cn.hutool.core.map.MapUtil;
import cn.hutool.core.util.StrUtil;
import cn.hutool.core.util.URLUtil;
import cn.hutool.http.Header;
import cn.hutool.log.dialect.console.ConsoleLog;
import cn.hutool.log.level.Level;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.SearchParser;
import com.pcdd.sonovel.parse.SearchParser6;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import com.pcdd.sonovel.util.RandomUA;
import com.pcdd.sonovel.util.SourceUtils;
import lombok.Data;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.junit.jupiter.api.Test;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Writer;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

/**
 * 根据起点榜单测试书源质量，结果写入 Markdown
 *
 * @author pcdd
 * Created at 2024/12/5
 */
class BookSourceQualityTest {

    static final AppConfig config = ConfigUtils.config();
    static final Map<String, List<Book>> ranks = new ConcurrentHashMap<>();
    // 测试排行榜前几名 (0,20]
    static final int TOP_NUM = 20;
    // 1：封IP，6：老书，12、15：限流，15：523错误
    static final String RE_SKIP_IDS = "1|6|12|15|16";

    static {
        JsoupUtils.trustAllSSL();
        ConsoleLog.setLevel(Level.OFF);
        config.setLanguage("zh_CN");
    }

    void qidianRankInit(Map<String, String> map) {
        for (Map.Entry<String, String> kv : map.entrySet()) {
            ranks.put(kv.getKey(), getQiDianRanks(kv.getValue()));
        }
    }

    List<Book> getQiDianRanks(String rankUrl) {
        Console.log("getQiDianRanks: {}", rankUrl);
        List<Book> rank = new ArrayList<>();
        Document document = null;
        try {
            document = Jsoup.connect(rankUrl)
                    .timeout(3000)
                    .header(Header.USER_AGENT.getValue(), RandomUA.generate())
                    .header(Header.COOKIE.getValue(), "w_tsfp=ltvuV0MF2utBvS0Q6qPpnE2sFzsidD04h0wpEaR0f5thQLErU5mG2IZyuMn2NHDf6sxnvd7DsZoyJTLYCJI3dwMSRpqReokRhQ/ElYgnjtxAVBI1QJzYWAJJJLly7DdAf3hCNxS00jA8eIUd379yilkMsyN1zap3TO14fstJ019E6KDQmI5uDW3HlFWQRzaLbjcMcuqPr6g18L5a5TjetFupeV8iA+sXhU3B3HlKWC4gskCyIuAJNBmlI5j5SqA=")
                    .get();
        } catch (IOException e) {
            Console.error(e);
        }

        Elements elements = document.select("#book-img-text > ul > li");
        // 取前 N 名
        for (Element e : elements.subList(0, TOP_NUM)) {
            String url = URLUtil.normalize(e.select("div.book-mid-info > h2 > a").attr("href"));
            String bookName = e.select("div.book-mid-info > h2 > a").text();
            String author = e.select("div.book-mid-info > p.author > a.name").text();

            Book book = new Book();
            book.setBookName(bookName);
            book.setAuthor(author);
            book.setUrl(url);

            rank.add(book);
        }

        return rank;
    }

    /**
     * 测试统计，前 20 名
     * test count: 11
     * thread: 6
     * search interval: 500 ~ 1000 ms
     * 4 m 41 s
     * <p>
     */
    @Test
    void test() {
        int count = SourceUtils.getCount();
        // 生成的 markdown 文件
        Map<String, String> map = Map.of(
                "1-起点月票榜", "https://www.qidian.com/rank/yuepiao/",
                "2-起点畅销榜", "https://www.qidian.com/rank/hotsales/",
                "3-起点阅读指数榜", "https://www.qidian.com/rank/readIndex/",
                "4-起点推荐榜·月榜", "https://www.qidian.com/rank/recom/datetype2/",
                "5-起点收藏榜", "https://www.qidian.com/rank/collect/",
                "6-起点签约作者新书榜", "https://www.qidian.com/rank/signnewbook/"
        );
        qidianRankInit(map);

        String divider = "-".repeat(50);
        ExecutorService threadPool = Executors.newFixedThreadPool(map.size());

        try {
            // 遍历榜单
            for (Map.Entry<String, String> kv : map.entrySet()) {
                threadPool.execute(() -> {
                    Console.log("{} {} {}", divider, kv.getKey(), divider);
                    Map<Integer, List<SourceQuality>> sourceQualityListMap = new HashMap<>();

                    // 遍历书源
                    for (int id = 1; id <= count; id++) {
                        Rule rule = new Source(id).rule;
                        // 跳过书源：不支持搜索的、搜索有限流的、搜索意义不大的、暂时无法访问的
                        if (rule.getSearch() != null && !String.valueOf(rule.getId()).matches(RE_SKIP_IDS)) {
                            sourceQualityListMap.put(id, getSourceQualityList(id, kv));
                        }
                    }

                    generateMarkdown(kv.getKey(), sourceQualityListMap);
                });
            }
        } catch (Exception e) {
            Console.log(e.getMessage());
        } finally {
            threadPool.shutdown();
            try {
                if (!threadPool.awaitTermination(10, TimeUnit.MINUTES)) {
                    threadPool.shutdownNow();
                }
            } catch (InterruptedException e) {
                threadPool.shutdownNow();
                Thread.currentThread().interrupt();
            }
        }
    }

    List<SourceQuality> getSourceQualityList(int id, Map.Entry<String, String> rank) {
        int foundCount = 0;
        int notFoundCount = 0;
        List<SourceQuality> list = new ArrayList<>();
        Rule rule = new Source(id).rule;

        String divider = "=".repeat(30);
        Console.log("{} 测试书源质量 {} | 书源 {} {} ({}) {}",
                divider, rank.getKey(), rule.getId(), rule.getUrl(), rule.getName(), divider);
        config.setSourceId(id);
        // 需要代理的书源
        config.setProxyEnabled(rule.isNeedProxy() ? 1 : 0);
        SearchParser sp = new SearchParser(config);
        SearchParser6 sp6 = new SearchParser6(config);

        // 遍历 20 本，即搜索源站 20 次，注意爬取频率
        for (Book b : ranks.get(rank.getKey())) {
            SourceQuality sq = new SourceQuality();
            sq.setSourceId(rule.getId());
            sq.setBookName(b.getBookName());
            sq.setAuthor(b.getAuthor());
            sq.setQiDianUrl(b.getUrl());

            List<SearchResult> results;
            if (config.getSourceId() == 6) {
                results = sp6.parse(b.getBookName());
            } else {
                results = sp.parse(b.getBookName());
            }
            boolean found = false;
            for (SearchResult r : results) {
                if (Objects.equals(r.getBookName(), b.getBookName()) && Objects.equals(r.getAuthor(), b.getAuthor())) {
                    Console.log("书源 {} 已找到《{}》（{}）{}\t{}\t{}",
                            id, r.getBookName(), r.getAuthor(), rank.getKey(), r.getUrl(), b.getUrl());
                    sq.setUrl(r.getUrl());
                    found = true;
                    foundCount++;
                    break;
                }
            }
            if (!found) {
                Console.log("书源 {} 未找到《{}》（{}）{}\t{}",
                        id, b.getBookName(), b.getAuthor(), rank.getKey(), b.getUrl());
                notFoundCount++;
            }
            sq.setFound(found);
            list.add(sq);

            // 针对搜索限流书源的处理
            /* int randomInt = RandomUtil.randomInt(200, 500);
            Console.log("搜索间隔 {} ms", randomInt);
            try {
                Thread.sleep(randomInt);
            } catch (InterruptedException e) {
                Console.error(e);
            } */
        }
        Console.log("书源 {} ({})，{}已找到 {} 本，未找到 {} 本\n\n",
                rule.getId(), rule.getUrl(), rank.getKey(), foundCount, notFoundCount);

        return list;
    }

    void generateMarkdown(String title, Map<Integer, List<SourceQuality>> map) {
        if (MapUtil.isEmpty(map)) {
            Console.error("{} sourceQualityListMap 为空", title);
            return;
        }

        String fileName = "qidian_rank/%s.md".formatted(title);
        Console.log("<== generateMarkdown: {}", fileName);
        // 表头
        StringBuilder sourceNameCol = new StringBuilder("|");
        // 分隔线
        StringBuilder dividerCol = new StringBuilder("|");

        for (Integer id : map.keySet()) {
            sourceNameCol.append(" 书源 ").append(id).append(" |");
            dividerCol.append(" ---- |");
        }

        StringBuilder md = new StringBuilder();
        // # 起点xx榜前 TOP_NUM (yyyy-MM-dd)
        md.append(StrUtil.format("{}前 {} 名 ({})\n",
                "# " + title,
                TOP_NUM,
                DateTime.now().toString(DatePattern.NORM_DATE_PATTERN)));
        md.append(StrUtil.format("| 排名 | 书名 | 作者 {} 起点链接 |\n", sourceNameCol));
        md.append(StrUtil.format("| ---- | ---- | ---- {} ---- |\n", dividerCol));

        // 获取 map 任意非空元素的 value
        List<SourceQuality> list = CollUtil.getFirst(CollUtil.filter(map.values(), Objects::nonNull));
        for (int i = 0; i < list.size(); i++) {
            SourceQuality o = list.get(i);
            StringBuilder foundBuilder = new StringBuilder();

            for (List<SourceQuality> item : map.values()) {
                SourceQuality sq = item.get(i);
                foundBuilder.append(StrUtil.format("{} |", sq.getFound() ? "✅" : "❌"));
            }

            md.append(StrUtil.format("| {} | {} | {} | {} {} |\n",
                    i + 1,
                    o.getBookName(),
                    o.getAuthor(),
                    foundBuilder,
                    o.getQiDianUrl()));
        }

        try {
            File file = new File(fileName);
            file.getParentFile().mkdirs();
            Writer writer = new FileWriter(file);
            writer.write(md.toString());
            writer.flush();
            writer.close();
        } catch (IOException e) {
            Console.error(e);
        }
    }

}

@Data
class SourceQuality {
    Integer sourceId;
    String bookName;
    String author;
    Boolean found;
    String url;
    String qiDianUrl;
}