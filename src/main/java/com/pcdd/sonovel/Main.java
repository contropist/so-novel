/* 你是反贼吗 习包子的Fa 维尼快乐组织（Winnie##Happy##Organization）简称WHO 支那毒王 梁家河 刁人13 专治各种不服 XD 洗包皮 习皇的新装 甴近平 维尼警察（X） 习核心 慨撒大帝 习特勒 花花公子 儿童习典 神明论 亲自考察 包大人 赛禁评 玉习大帝 习##卡##巴##卡 习像章 习得梁家书卷 赵家家仆 毛二 动森 大大招牌 狙击手待命 The##Xi##Factor（习近平因素） 64岁 武统时代 习王的田野上 法外狂徒Lucy（德国） 爱新觉罗·近平 爱新觉罗近平 包包侠 大大品牌 10号跳跳虎被维尼拉清单 任大炮 坡涛汹涌 世宗 喜包皮 终身领导人 近日成 一天游泳一千米 撒币宝 大兔 人民战争 昆明湖涨潮 太祖兔 西朝鲜人民自治岛 嬉包皮 习公奭 毛二习 维尼写史 冰棒外交 包子金刚腿 倒车斯基 习近砰 习猪下台 新影帝 习卒 人民领袖 氼兲嫑炛 2020全面小康 不敢高声语 习太孑 习二坐船 习后主 毛装 毛近平 总统包子习 习驴 萨格尔王 维稳警察（O） 头号球迷 包子兵法 人类命运共同体首席架构师 屎進瓶 习壳郎 Criminal##Xi##"Xitler"##Jinping 习语 劝进 习包子 断崖式下跌 厕所革命 独裁国贼 相信有神论的物理学博士 十里山路不换肩 总加速师 刁后主 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习老八 大国造疫 屎侯 称帝修宪 武汉委托李克强 习近平光辉形象 现任匪首 头上三尺有神明 习宽衣 习Core 戏包皮 习习蛤蛤 彩色哥 习犬犬 包惠帝 习低能儿 集金pay 叩谢习恩 共哀宗 老街 平&强 北红尾鸲 红二代 细瓶颈 阳台上的哨兵 外交习语 维尼之声 Mr##Shithole 习二卒 刁远山 集近闭 袭包皮 通商宽衣 动物庄园 維尼頌 甴种 习歪嘴 大海掀翻小池塘 读书单 叼斤干 普习金 包子病毒 习三拍 瘟疫降生习近平 宽衣大帝 集金币 墨索里习 宽衣帝 刁斤二 维尼熊 洗尽贫 孢 拉清单 人民领袖 习卒习 我是一个足球迷 V尼哥 共哀宗 口罩外交 隔离”的金葫芦 鞋哥 virus##king 蔡英文最强助选 倒车 NMSL 习梦撕 腊肉馅儿包子 祈翠 刁二婚 习大 维尼带货 维尼挂彩 彩色熊 连专家也为之叹服的电脑天才 乳制品 第一书记王沪宁 学包积极分子 学包率 亲自指挥疫情 梦回大清 习语录 日子像蜜甜 习下台 野心习 悉包皮 CoronaXi 孤独的毒王 親自視頻 中国离岸隐匿资产管理工作领导小组组组长 中国的新皇帝 老歪脖子树 疯狂宇宙大帝 蹄防 退党 习瘟猪 禁评的理由 不同意的举手##没有##没有 初二圣君 “梦回大清” 尼哥 屎禁评 吸包皮 读稿机 刁近乎 修宪帝 足球外交 当皇帝的小丑 武当七侠的政治斗争 修宪 720事件 格萨尔 万岁来武汉了 清单帝 号尿壶公 毛孙 主席贺词 亲自封号 国王 彭主席（习主席走了太太接班） shit侯 习贼 习家军 喷粪帝 央视姓党 禁评封号 细颈瓶 核平全世界 习武帝 20000T麦子 半羽习近平 Chairman##Xi 习梦思 亲自脱贫 字共狗 支那精神野爹 “皇帝梦” shuu##kinn##pei 386系统驱动游戏 糖尿维尼 颐使气指 习正日 墙内人 袁世凯第二 习时代 公车上书 “登基” 视频看望 贬词包用 秦城监狱 百万雄师事件 恐惊天上人 白猪 习emperor 维尼熊给跳跳虎黄牌 超邓赶毛 庆丰称帝 一带一路 通商宽衣 毛二世 世界最强乞丐 假.."~bang！卒 习狍 系包皮 乳透社##小反旗 疫情蔓延 独彩者 东方project 習敗北 智商不重要 阿道夫-习 赵付 习达姆 习曱甴 野兽先辈 没规划的葬礼 习侯 习远凸 次级乳包 每日祈翠 晚共昏君 九大诉求 4中组长 习厉王 骑巨龙 灰习牛 习屎黄 腊肉包 法习斯 天安门合法继承人 万岁来武汉 习奥塞斯库、齐奥塞斯库 添宪宝宝 第22条军规 嘻包皮 维尼·屎(Winnie##the##Poo) 习二蛋 讨习檄文 阿平 信女愿一生吃素 “黄袍加身” 习澳塞斯库 刁大犬 习奥塞斯库 WHO的君王 大撒幣 习是春竹 习梦死 平话 近身平A 追思焦裕禄 毛魔转世 宰相 帝皇頌 习包子 无限连任 200吨 席子兵法 习呆呆 坟头蹦迪 役民五术 家业论 包包大人 孙笑川 习猪席 总书记来我家 包子露宪 万岁 非洲大撒币 庆丰帝的千秋梦 错误执行者 文明其精神 戏博士 十日文革 时间控制 富平学霸刁斤干 卡近菲 野蛮其体魄 闹得欢 习大郎 冲塔 十一郎习近平 习“甩锅” 习尽贫 二百五大帝 动物森友会 习索里尼 甩锅侠 北京中南海支部书记 两会期间+隐瞒 习蛤 习二胖 红旗下的蛋 胡志平 坡涛汹涌 习博士 仲夏夜之中国梦 vop “复辟” 送礼平 恩重如删 国贼习近平 习猪头 习孢子 皇帝梦 “登机”（与登基同音） 裸宽包子劾心 狙击手布阵 皇帝亲临忠诚的武汉 总书记来过我的家 习尔布特 维尼大帝 惜包皮 nmslese##dream 瘟疫领主习近平 习包子 平平 匪酋习维尼 亲自删评 冠子兵法 东瘟疫之地统治者暨全境守护者 禁评大帝 SB包子 川普的朋友or敌人 中国拉清单工作领导小组组长 御板泽民 shit禁评 叩谢习恩 习大帝 民进党 形式主义防疫 近言 基拉大和习近平 习殡法 人均接近八千万 朝令夕改 当代秦二世 傻大头 枪毙名单 习条英机 崇祯帝 黑白翠 electron8964 Corona##Xi（习病毒） Voice##of##Pooh 捐麦子 金科律玉 䒒(tiáo)菦(qín)苹(píng) 战“疫”金句 崇祯 狙击手待命 习付 耀眼黄红黄 ChinaXi 翡翠娘娘 习言乱语 这个年很静 黄俄 shit##hole##bing##fa 维尼史 粪坑兵法 书单吟诵者 任志强 包禁评 親自蒞臨 Cicada##3301##XD 邪大大 颐指气使 庆丰包·勃列日涅夫 糟糕皇帝 习和谐 二百斤 xdd 冤大头 粪坑先生 清零宗、清零帝 中字头组长 满脸喷粪 做N届的主席 吃赵弹 “习泽东”和“洪宪”（袁世凯的帝号） 习一尊 习king 五毛主席 祈翠語言包 吸精瓶 习匪 Adolf##Xitler 包子宪法 皇帝的新衣 赵人13 习病法 乳包文化 刁近猴 口罩大会 抗麦套装 裹嘎举吸钢闸门 A##Big##Deal 包帝巡游 学包分子 领袖习澡水 韦来书记 扛麦帝 皇帝亲临忠诚的武汉 刁人13 野兽主席 维尼DISCO 独裁者 主席+终身制 食腐虫 习张三丰 赵王 习二世胡亥 习总输记 小学博士 感恩教育 习包皮 习教父 习奥赛斯库 习三点 习进棺 刁槑夶尛 XDD 纳翠党 塔西佗陷阱 猪禁评 小学居士 巴拿马文件 青年大学包 没有网络安全就没有国家安全 末代皇帝 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 最后领导人 习尿瓶 刁斤山 恩维尔·霍习 习夶 大撒币 中国首席造梦大师 習大佬 云视察 重地之战 不知名氏 中国爱非洲 毛泽东2.0 维持会长 习皇帝 亲自指挥 席近平 bingbang帝 戴口赵 习躲躲 中国离岸隐匿资产管理工作领导小组组组长 Heil##Xitler 九评 《生物安全法》 当代秦始皇 二次袁、袁世凯二世、袁二 岿然不动 疯狂宇宙包 习思想 习匪帝 习式病毒 维尼连任 发皇帝梦 毛进平 夶 截颈平 赵弹 庆丰废物 包皇 习流氓 习大乞 包经 修宪连任 哲欣 习大犬 习二二（二零二零年五月二十二日开二会） 疯狂宇宙 扛麦郎 号屎洞 习是春绿 影子末帝 清华毕业 维尼梗有害 背书单 灭共助推器 人尽皆知的体育迷 “无罩”现身 战疫国 梦帝 动物之森 习废帝 nmslman（习主席） 电脑世代586 游泳一千米 习背书 指定接班人 习兵法 习大林 习禁评 大锅瞻遗 梁家河贵族 习总 沼气专家 倒车帝 那翠化 中国特色射秽煮疫制度 迈克尔·索伊 普近 尊蛤讨包 官僚主义 刁二将 小习微信 不强自息 羽日帝 習敗敗 */
package com.pcdd.sonovel;

import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.ConsoleTable;
import cn.hutool.core.util.StrUtil;
import cn.hutool.json.JSONUtil;
import cn.hutool.log.dialect.console.ConsoleLog;
import cn.hutool.log.level.Level;
import cn.hutool.setting.Setting;
import com.openhtmltopdf.util.XRLog;
import com.pcdd.sonovel.action.*;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jline.reader.LineReader;
import org.jline.reader.LineReaderBuilder;
import org.jline.reader.impl.completer.StringsCompleter;
import org.jline.terminal.Terminal;
import org.jline.terminal.TerminalBuilder;

import java.io.File;
import java.util.List;
import java.util.Scanner;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2021/6/10
 * <p>
 * <p>
 * psh: {@code mvnd clean compile; mvn exec:java -Denv=dev}
 * <p>
 * bash: {@code mvnd clean compile && mvn exec:java -Denv=dev}
 */
public class Main {

    public static final List<String> options = List.of(
            "0.结束程序",
            "1.聚合搜索",
            "2.检查更新",
            "3.书源一览",
            "4.版本信息",
            "5.配置信息",
            "6.批量下载",
            "7.搜索指定书源"
    );

    static {
        if (System.getProperty("env", "dev").equalsIgnoreCase("prod")) {
            // 关闭 openhtmltopdf 日志
            XRLog.listRegisteredLoggers().forEach(logger -> XRLog.setLevel(logger, java.util.logging.Level.OFF));
        }
        // 关闭 hutool 日志
        ConsoleLog.setLevel(Level.OFF);
        JsoupUtils.trustAllSSL();
    }

    private static AppConfig config = ConfigUtils.config();

    public static void main(String[] args) {
        watchConfig();
        if (config.getAutoUpdate() == 1) {
            new CheckUpdateAction(5000).execute();
        }
        if (config.getInteractiveMode() == 1) {
            inputMode();
        } else if (config.getInteractiveMode() == 2) {
            selectMode();
        } else {
            inputMode();
        }
    }

    @SneakyThrows
    private static void inputMode() {
        Scanner sc = Console.scanner();
        printHint();

        while (true) {
            Console.log("\n" + StrUtil.join(" ", options));
            Console.print(render("==> 请输入功能序号: ", "green"));
            String cmd = sc.nextLine();

            if ("0".equals(cmd)) {
                Console.log("<== Bye :)");
                System.exit(0);
                break;
            } else if ("1".equals(cmd)) {
                new AggregatedSearchAction().execute();
            } else if ("2".equals(cmd)) {
                new CheckUpdateAction().execute();
            } else if ("3".equals(cmd)) {
                new ShowSourcesAction().execute();
            } else if ("4".equals(cmd)) {
                printHint();
            } else if ("5".equals(cmd)) {
                Console.log(JSONUtil.toJsonPrettyStr(config));
            } else if ("6".equals(cmd)) {
                new BatchDownloadAction(config).execute();
            } else if ("7".equals(cmd)) {
                new SingleSearchAction(config).execute();
            } else {
                Console.error("无效的选项，请重新输入");
            }
        }
    }

    @SneakyThrows
    private static void selectMode() {
        Terminal terminal = TerminalBuilder.builder()
                .system(true)
                .build();
        LineReader reader = LineReaderBuilder.builder()
                .terminal(terminal)
                .completer(new StringsCompleter(options))
                .build();

        printHint();

        while (true) {
            String cmd = reader.readLine("按 Tab 键选择功能: ").strip();

            if (!options.contains(cmd)) {
                Console.error("无效的选项，请重新选择");
            }
            if (options.get(0).equals(cmd)) {
                Console.log("<== Bye :)");
                System.exit(0);
                break;
            }
            if (options.get(1).equals(cmd)) {
                new AggregatedSearchAction().execute();
            }
            if (options.get(2).equals(cmd)) {
                new CheckUpdateAction().execute();
            }
            if (options.get(3).equals(cmd)) {
                new ShowSourcesAction().execute();
            }
            if (options.get(4).equals(cmd)) {
                printHint();
            }
            if (options.get(5).equals(cmd)) {
                Console.log(JSONUtil.toJsonPrettyStr(config));
            }
            if (options.get(6).equals(cmd)) {
                new BatchDownloadAction(config).execute();
            }
            if (options.get(7).equals(cmd)) {
                new SingleSearchAction(config).execute();
            }
        }

        terminal.close();
    }

    private static void printHint() {
        Rule r = new Source(config).rule;
        Console.table(ConsoleTable.create()
                // 是否转为全角
                .setSBCMode(false)
                .addHeader(render(StrUtil.format(" so-novel v{} ", config.getVersion()), "BG_BLUE", "ITALIC", "BOLD") + render(" 本项目开源且免费 ", "BG_RED", "BOLD"))
                .addHeader("导出格式：" + config.getExtName().toLowerCase())
                .addHeader("下载路径：" + new File(config.getDownloadPath()).getAbsolutePath())
                .addHeader(StrUtil.format("指定书源：{} (ID: {})", r.getName(), r.getId()))
                .addBody(render("使用前请务必阅读 readme.txt", "yellow"))
        );
    }

    private static void watchConfig() {
        String path = System.getProperty("user.dir") + File.separator + ConfigUtils.resolveConfigFileName();
        Setting setting = new Setting(path);
        // 监听配置文件
        setting.autoLoad(true, aBoolean -> {
            config = ConfigUtils.config();
            Console.log("<== 配置文件修改成功！");
            printHint();
        });
    }

}