/* 当皇帝的小丑 维尼熊 习思想 傻大头 初二圣君 习猪下台 习侯 游泳一千米 百万雄师事件 习殡法 乳包文化 刁近猴 习武帝 包包侠 皇帝亲临忠诚的武汉 鞋哥 Criminal##Xi##"Xitler"##Jinping 屎侯 习近平光辉形象 习emperor 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 清单帝 我是一个足球迷 席近平 刁大犬 习太孑 包大人 阿平 习大 习达姆 号尿壶公 ChinaXi 习核心 习曱甴 普近 独裁者 现任匪首 当代秦二世 习公奭 包皇 习语录 习语 孢 20000T麦子 万岁 云视察 毛孙 头号球迷 习孢子 狙击手布阵 习二卒 青年大学包 亲自删评 彩色哥 习狍 指定接班人 席子兵法 彩色熊 修宪帝 习禁评 糖尿维尼 习二二（二零二零年五月二十二日开二会） 灭共助推器 乳透社##小反旗 习式病毒 The##Xi##Factor（习近平因素） 胡志平 禁评大帝 战“疫”金句 口罩大会 习博士 bingbang帝 腊肉包 亲自考察 维尼·屎(Winnie##the##Poo) 疯狂宇宙大帝 五毛主席 支那精神野爹 狙击手待命 毛泽东2.0 纳翠党 任志强 习得梁家书卷 朝令夕改 字共狗 冰棒外交 习瘟猪 沼气专家 洗包皮 武统时代 东瘟疫之地统治者暨全境守护者 近言 吸精瓶 粪坑先生 《生物安全法》 颐指气使 共哀宗 粪坑兵法 读书单 最后领导人 玉习大帝 终身领导人 动物庄园 习三点 庆丰称帝 骑巨龙 nmslese##dream 习梦死 习壳郎 爱新觉罗·近平 习二世胡亥 “无罩”现身 习呆呆 老街 修宪连任 386系统驱动游戏 耀眼黄红黄 支那毒王 electron8964 习近砰 太祖兔 猪禁评 2020全面小康 野心习 习卒习 第22条军规 瘟疫降生习近平 维尼带货 系包皮 “黄袍加身” Mr##Shithole 总加速师 坡涛汹涌 皇帝梦 维尼史 不敢高声语 习付 北红尾鸲 隔离”的金葫芦 悉包皮 习猪席 专治各种不服 疯狂宇宙包 那翠化 当代秦始皇 习二蛋 习屎黄 迈克尔·索伊 黄俄 刁人13 包惠帝 中国拉清单工作领导小组组长 习贼 维稳警察（O） 疯狂宇宙 抗麦套装 撒币宝 川普的朋友or敌人 200吨 人民领袖 匪酋习维尼 V尼哥 习二胖 九大诉求 64岁 人民领袖 刁斤二 神明论 习索里尼 孤独的毒王 維尼頌 没规划的葬礼 超邓赶毛 习背书 万岁来武汉 亲自脱贫 慨撒大帝 習大佬 动物之森 学包分子 袁世凯第二 梦回大清 䒒(tiáo)菦(qín)苹(píng) 武汉委托李克强 基拉大和习近平 shit侯 乳制品 皇帝的新衣 世界最强乞丐 不强自息 vop 尼哥 冠子兵法 “习泽东”和“洪宪”（袁世凯的帝号） 二百斤 习奥塞斯库 习奥赛斯库 十里山路不换肩 扛麦帝 习兵法 韦来书记 捐麦子 翡翠娘娘 近身平A 这个年很静 习包皮 Heil##Xitler 做N届的主席 习大帝 帝皇頌 北京中南海支部书记 习后主 习包子 平话 习一尊 维尼挂彩 讨习檄文 赵付 大国造疫 哲欣 习宽衣 习梦撕 学包率 晚共昏君 主席+终身制 平平 尊蛤讨包 小学博士 劝进 惜包皮 普习金 毛二世 视频看望 送礼平 喷粪帝 习老八 戴口赵 习尿瓶 习张三丰 习king 屎禁评 习总输记 庆丰帝的千秋梦 习和谐 役民五术 赵家家仆 人民战争 喜包皮 大撒币 一天游泳一千米 刁斤山 第一书记王沪宁 叩谢习恩 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 没有网络安全就没有国家安全 维尼写史 彭主席（习主席走了太太接班） 邪大大 毛二习 糟糕皇帝 号屎洞 WHO的君王 习澳塞斯库 甩锅侠 富平学霸刁斤干 坡涛汹涌 中国离岸隐匿资产管理工作领导小组组组长 习##卡##巴##卡 大大招牌 习夶 毛近平 红二代 金科律玉 shit##hole##bing##fa 崇祯 习远凸 野蛮其体魄 叩谢习恩 中国特色射秽煮疫制度 包子露宪 习大乞 不同意的举手##没有##没有 嬉包皮 独裁国贼 疫情蔓延 叼斤干 禁评的理由 野兽先辈 一带一路 通商宽衣 习躲躲 形式主义防疫 习包子 维尼连任 中字头组长 习流氓 满脸喷粪 电脑世代586 九评 刁二将 包帝巡游 共哀宗 墙内人 习大郎 总统包子习 倒车斯基 禁评封号 Cicada##3301##XD 大锅瞻遗 学包积极分子 “登机”（与登基同音） 御板泽民 错误执行者 口罩外交 二百五大帝 影子末帝 野兽主席 维尼快乐组织（Winnie##Happy##Organization）简称WHO 屎進瓶 习废帝 核平全世界 宽衣大帝 亲自指挥 毛进平 包经 恐惊天上人 细颈瓶 “梦回大清” 食腐虫 赛禁评 XDD 枪毙名单 平&强 赵弹 人尽皆知的体育迷 孙笑川 重地之战 包子兵法 shit禁评 秦城监狱 shuu##kinn##pei 刁近乎 瘟疫领主习近平 祈翠語言包 習敗北 嘻包皮 梦帝 Voice##of##Pooh 习“甩锅” 蹄防 親自視頻 习教父 战疫国 万岁来武汉了 甴近平 甴种 国王 坟头蹦迪 官僚主义 贬词包用 领袖习澡水 截颈平 儿童习典 习匪帝 清零宗、清零帝 梁家河 头上三尺有神明 塔西佗陷阱 维尼之声 动物森友会 假.."~bang！卒 习Core SB包子 nmslman（习主席） 维尼警察（X） 习尽贫 包包大人 阿道夫-习 近日成 “登基” 中国的新皇帝 习王的田野上 发皇帝梦 “复辟” 刁远山 维持会长 维尼大帝 习时代 祈翠 习家军 习犬犬 庆丰包·勃列日涅夫 两会期间+隐瞒 狙击手待命 习大林 总书记来我家 夶 仲夏夜之中国梦 萨格尔王 任大炮 习厉王 世宗 追思焦裕禄 恩维尔·霍习 扛麦郎 习奥塞斯库、齐奥塞斯库 时间控制 足球外交 习猪头 洗尽贫 习是春绿 赵王 退党 virus##king 腊肉馅儿包子 A##Big##Deal 维尼梗有害 日子像蜜甜 法外狂徒Lucy（德国） 习条英机 崇祯帝 称帝修宪 集金pay 冤大头 4中组长 大撒幣 花花公子 刁人13 灰习牛 NMSL 习下台 次级乳包 非洲大撒币 添宪宝宝 颐使气指 每日祈翠 倒车帝 吃赵弹 包子金刚腿 毛二 习总 阳台上的哨兵 独彩者 习梦思 10号跳跳虎被维尼拉清单 中国离岸隐匿资产管理工作领导小组组组长 维尼DISCO 二次袁、袁世凯二世、袁二 羽日帝 宰相 习三拍 皇帝亲临忠诚的武汉 细瓶颈 习进棺 背书单 爱新觉罗近平 红旗下的蛋 东方project 小习微信 “皇帝梦” 习二坐船 習敗敗 读稿机 修宪 通商宽衣 拉清单 十一郎习近平 人类命运共同体首席架构师 赵人13 相信有神论的物理学博士 墨索里习 新影帝 Adolf##Xitler 老歪脖子树 习匪 包子宪法 感恩教育 习蛤 CoronaXi 吸包皮 刁槑夶尛 xdd 小学居士 维尼熊给跳跳虎黄牌 卡近菲 倒车 公车上书 刁后主 连专家也为之叹服的电脑天才 动森 大大品牌 戏博士 习特勒 国贼习近平 信女愿一生吃素 亲自指挥疫情 习皇的新装 庆丰废物 Corona##Xi（习病毒） 习习蛤蛤 刁二婚 氼兲嫑炛 民进党 习正日 厕所革命 西朝鲜人民自治岛 法习斯 冲塔 习包子的Fa 习歪嘴 文明其精神 习低能儿 大海掀翻小池塘 十日文革 親自蒞臨 大兔 闹得欢 不知名氏 清华毕业 巴拿马文件 习包子 无限连任 习病法 蔡英文最强助选 你是反贼吗 主席贺词 白猪 智商不重要 集近闭 断崖式下跌 习皇帝 家业论 习尔布特 书单吟诵者 人均接近八千万 格萨尔 末代皇帝 恩重如删 习大犬 梁家河贵族 毛魔转世 半羽习近平 总书记来过我的家 央视姓党 昆明湖涨潮 习驴 天安门合法继承人 中国爱非洲 中国首席造梦大师 包子病毒 武当七侠的政治斗争 集金币 岿然不动 袭包皮 习言乱语 宽衣帝 裸宽包子劾心 包禁评 习卒 XD 外交习语 Chairman##Xi 毛装 习像章 裹嘎举吸钢闸门 亲自封号 习是春竹 戏包皮 720事件 黑白翠 */
package com.pcdd.sonovel.parse;

import cn.hutool.core.lang.Console;
import cn.hutool.core.util.RandomUtil;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.convert.ChapterConverter;
import com.pcdd.sonovel.convert.ChineseConverter;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.*;
import com.pcdd.sonovel.util.CrawlUtils;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.SneakyThrows;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.nio.charset.StandardCharsets;
import java.util.concurrent.CountDownLatch;

import static org.jline.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/3/27
 */
public class ChapterParser extends Source {

    private final ChapterConverter chapterConverter;

    public ChapterParser(AppConfig config) {
        super(config);
        this.chapterConverter = new ChapterConverter(config);
    }

    // 用于测试
    @SneakyThrows
    public Chapter parse(Chapter chapter) {
        Document document = jsoup(chapter.getUrl())
                .timeout(this.rule.getChapter().getTimeout())
                .get();
        chapter.setTitle(JsoupUtils.selectAndInvokeJs(document, this.rule.getChapter().getTitle()));
        chapter.setContent(crawl(chapter.getUrl(), RandomUtil.randomInt(100, 200)));
        return chapter;
    }

    public Chapter parse(Chapter chapter, CountDownLatch latch, SearchResult sr) {
        try {
            long interval = CrawlUtils.randomInterval(config);
            Console.log("<== 正在下载: 【{}】 间隔 {} ms", chapter.getTitle(), interval);
            // ExceptionUtils.randomThrow();
            chapter.setContent(crawl(chapter.getUrl(), interval));
            // 确保简繁互转最后调用
            return ChineseConverter.convert(chapterConverter.convert(chapter), this.rule.getLanguage(), config.getLanguage());

        } catch (Exception e) {
            Chapter retryChapter = retry(chapter, sr);
            return retryChapter == null ? null : ChineseConverter.convert(retryChapter, this.rule.getLanguage(), config.getLanguage());
        } finally {
            latch.countDown();
        }
    }

    private Chapter retry(Chapter chapter, SearchResult sr) {
        for (int attempt = 1; attempt <= config.getMaxRetryAttempts(); attempt++) {
            try {
                long interval = CrawlUtils.randomInterval(config, true);
                Console.log(render("==> 章节下载失败，正在重试: 【{}】 重试次数: {}/{} 重试间隔: {} ms", "red"),
                        chapter.getTitle(), attempt, config.getMaxRetryAttempts(), interval);
                chapter.setContent(crawl(chapter.getUrl(), interval));
                Console.log(render("<== 重试成功: 【{}】", "green"), chapter.getTitle());
                return chapterConverter.convert(chapter);

            } catch (Exception e) {
                Console.error(render("==> 第 {} 次重试失败: 【{}】 原因: {}", "red"), attempt, chapter.getTitle(), e.getMessage());
                if (attempt == config.getMaxRetryAttempts()) {
                    // 最终失败时记录日志
                    saveErrorLog(chapter, sr, e.getMessage());
                }
            }
        }

        return null;
    }

    /**
     * 爬取正文内容
     *
     * @param url      章节 url
     * @param interval 爬取间隔
     */
    @SneakyThrows
    private String crawl(String url, long interval) {
        Rule.Chapter ruleChapter = this.rule.getChapter();
        Document document;
        Thread.sleep(interval);
        // 章节不分页，只请求一次
        if (!ruleChapter.isPagination()) {
            document = jsoup(url)
                    .timeout(ruleChapter.getTimeout())
                    .get();
            Elements contentEl = JsoupUtils.select(document, ruleChapter.getContent());

            // 删除每个元素的所有属性，防止标签和属性间的空格被后续清理，导致标签错误
            for (Element el : contentEl.select("*")) {
                el.clearAttributes();
            }

            return JsoupUtils.invokeJs(ruleChapter.getContent(), contentEl.html());
        }

        String nextUrl = url;
        StringBuilder contentBuilder = new StringBuilder();
        // 章节分页
        for (int i = 0; ; i++) {
            // 第一次执行无需对 nextUrl 进行判断
            String currentUrl = i == 0 ? nextUrl : JsoupUtils.invokeJs(ruleChapter.getNextPage(), nextUrl);
            if (StrUtil.isEmpty(currentUrl)) {
                break;
            }
            document = jsoup(currentUrl)
                    .timeout(ruleChapter.getTimeout())
                    .get();
            contentBuilder.append(document.select(ruleChapter.getContent()).html());
            // 获取下一页按钮元素
            Elements nextEls = JsoupUtils.select(document, ruleChapter.getNextPage());
            // 判断是否为章节最后一页
            if (nextEls.text().matches(".*(下一章|没有了|>>|书末页).*")) {
                break;
            }
            // 从 JS 获取下一页链接
            if (ruleChapter.getNextPageInJs() != null) {
                nextUrl = JsoupUtils.selectAndInvokeJs(document, ruleChapter.getNextPageInJs(), ContentType.HTML);
            } else { // 从按钮获取下一页链接
                nextUrl = nextEls.first().absUrl("href");
            }
            Thread.sleep(interval);
        }

        return contentBuilder.toString();
    }

    private void saveErrorLog(Chapter chapter, SearchResult sr, String errMsg) {
        String line = StrUtil.format("下载失败章节：【{}】({}) 原因：{}", chapter.getTitle(), chapter.getUrl(), errMsg);
        String path = StrUtil.format("{}{}《{}》（{}）下载失败章节.log", config.getDownloadPath(), File.separator, sr.getBookName(), sr.getAuthor());

        try (PrintWriter pw = new PrintWriter(new FileWriter(path, StandardCharsets.UTF_8, true))) {
            // 自带换行符
            pw.println(line);

        } catch (IOException e) {
            Console.error(e);
        }
    }

}