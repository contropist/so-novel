/* 小学居士 习病法 习正日 朝令夕改 官僚主义 宽衣大帝 猪禁评 儿童习典 屎禁评 集近闭 超邓赶毛 习贼 习猪席 习包子 习包子 习侯 第22条军规 红二代 你是反贼吗 头号球迷 习流氓 扛麦郎 亲自指挥疫情 V尼哥 习王的田野上 包经 彩色熊 满脸喷粪 役民五术 习屎黄 赵王 世界最强乞丐 近言 习壳郎 太祖兔 包帝巡游 天安门合法继承人 捐麦子 禁评的理由 细瓶颈 习呆呆 习思想 鞋哥 不敢高声语 坡涛汹涌 毛装 羽日帝 XD 枪毙名单 习进棺 习废帝 习蛤 富平学霸刁斤干 习猪下台 “黄袍加身” 近身平A 习三拍 习言乱语 维尼熊 修宪连任 平平 最后领导人 习大林 影子末帝 外交习语 修宪 習大佬 习匪帝 庆丰废物 亲自脱贫 shit侯 人尽皆知的体育迷 当代秦二世 10号跳跳虎被维尼拉清单 智商不重要 64岁 纳翠党 当代秦始皇 XDD 恩重如删 细颈瓶 退党 称帝修宪 隔离”的金葫芦 包包侠 骑巨龙 维尼连任 大国造疫 号尿壶公 扛麦帝 禁评大帝 刁远山 习二卒 世宗 Adolf##Xitler 孙笑川 习大 毛二 习二世胡亥 末代皇帝 书单吟诵者 习殡法 喜包皮 疯狂宇宙 家业论 习“甩锅” 屎進瓶 九评 皇帝的新衣 毛二习 国王 习达姆 现任匪首 腊肉包 大兔 CoronaXi The##Xi##Factor（习近平因素） 洗尽贫 shit##hole##bing##fa 支那毒王 习歪嘴 洗包皮 口罩外交 东瘟疫之地统治者暨全境守护者 包大人 冠子兵法 习条英机 习武帝 总书记来过我的家 习包子的Fa 习总 吸精瓶 尊蛤讨包 人类命运共同体首席架构师 刁槑夶尛 白猪 习犬犬 习老八 号屎洞 习特勒 习下台 Criminal##Xi##"Xitler"##Jinping 狙击手布阵 不同意的举手##没有##没有 叼斤干 追思焦裕禄 假.."~bang！卒 国贼习近平 口罩大会 毛魔转世 毛泽东2.0 氼兲嫑炛 䒒(tiáo)菦(qín)苹(píng) 倒车 刁后主 “习泽东”和“洪宪”（袁世凯的帝号） 灰习牛 连专家也为之叹服的电脑天才 386系统驱动游戏 信女愿一生吃素 习包子 蹄防 每日祈翠 总书记来我家 读书单 慨撒大帝 新影帝 岿然不动 嬉包皮 云视察 习教父 习梦死 邪大大 字共狗 习式病毒 包子露宪 视频看望 金科律玉 糟糕皇帝 支那精神野爹 野兽主席 包子兵法 恩维尔·霍习 日子像蜜甜 Voice##of##Pooh 孢 集金币 冰棒外交 感恩教育 主席贺词 親自蒞臨 吸包皮 维尼大帝 武当七侠的政治斗争 背书单 维尼警察（X） 720事件 包禁评 民进党 亲自删评 赵弹 送礼平 宽衣帝 维持会长 一天游泳一千米 中国离岸隐匿资产管理工作领导小组组组长 习像章 惜包皮 維尼頌 皇帝亲临忠诚的武汉 电脑世代586 东方project 2020全面小康 御板泽民 梦帝 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 庆丰包·勃列日涅夫 塔西佗陷阱 Cicada##3301##XD NMSL 习梦撕 习近平光辉形象 万岁来武汉 人民领袖 悉包皮 包皇 习近砰 赛禁评 刁二婚 野兽先辈 翡翠娘娘 中国首席造梦大师 大大招牌 公车上书 vop 耀眼黄红黄 亲自封号 任志强 维尼DISCO 第一书记王沪宁 无限连任 习厉王 五毛主席 毛进平 爱新觉罗·近平 胡志平 清单帝 武汉委托李克强 禁评封号 “登机”（与登基同音） 刁斤山 习奥塞斯库 刁人13 半羽习近平 屎侯 习背书 灭共助推器 4中组长 糖尿维尼 习躲躲 不知名氏 修宪帝 颐指气使 习远凸 皇帝亲临忠诚的武汉 通商宽衣 习孢子 北红尾鸲 当皇帝的小丑 基拉大和习近平 维尼梗有害 撒币宝 习卒 学包积极分子 哲欣 普习金 专治各种不服 嘻包皮 习猪头 习皇帝 习是春绿 习太孑 习时代 习宽衣 野心习 刁大犬 nmslman（习主席） 乳制品 瘟疫降生习近平 清华毕业 習敗北 我是一个足球迷 野蛮其体魄 裹嘎举吸钢闸门 习大犬 文明其精神 老街 百万雄师事件 virus##king 崇祯 动物庄园 做N届的主席 shit禁评 习emperor 皇帝梦 晚共昏君 不强自息 战疫国 疯狂宇宙大帝 喷粪帝 习习蛤蛤 学包率 习澳塞斯库 发皇帝梦 习禁评 央视姓党 共哀宗 添宪宝宝 沼气专家 万岁 习公奭 学包分子 维尼写史 大撒币 维尼之声 川普的朋友or敌人 WHO的君王 包子金刚腿 动物森友会 近日成 梦回大清 维尼熊给跳跳虎黄牌 倒车斯基 帝皇頌 九大诉求 独裁者 习大乞 坡涛汹涌 动物之森 游泳一千米 人均接近八千万 倒车帝 习一尊 ChinaXi 中国离岸隐匿资产管理工作领导小组组组长 独彩者 刁斤二 阳台上的哨兵 梁家河 战“疫”金句 甴近平 一带一路 習敗敗 中国特色射秽煮疫制度 宰相 大撒幣 赵付 甩锅侠 主席+终身制 xdd 习梦思 祈翠 习大郎 这个年很静 形式主义防疫 昆明湖涨潮 习张三丰 维尼史 抗麦套装 裸宽包子劾心 十日文革 十里山路不换肩 北京中南海支部书记 大锅瞻遗 习低能儿 庆丰称帝 仲夏夜之中国梦 集金pay 核平全世界 中国拉清单工作领导小组组长 冲塔 戴口赵 彩色哥 贬词包用 冤大头 独裁国贼 戏包皮 傻大头 坟头蹦迪 习二胖 习皇的新装 亲自考察 习尔布特 袭包皮 秦城监狱 二次袁、袁世凯二世、袁二 大海掀翻小池塘 electron8964 习家军 Chairman##Xi 习和谐 腊肉馅儿包子 Mr##Shithole 彭主席（习主席走了太太接班） 袁世凯第二 劝进 小学博士 维稳警察（O） 红旗下的蛋 闹得欢 nmslese##dream 动森 习兵法 维尼·屎(Winnie##the##Poo) 总统包子习 系包皮 重地之战 习后主 习夶 武统时代 甴种 瘟疫领主习近平 非洲大撒币 崇祯帝 阿道夫-习 人民战争 “皇帝梦” SB包子 初二圣君 花花公子 维尼快乐组织（Winnie##Happy##Organization）简称WHO 墨索里习 习博士 黄俄 親自視頻 “登基” 平话 人民领袖 讨习檄文 狙击手待命 亲自指挥 习语录 习匪 习狍 清零宗、清零帝 “梦回大清” 黑白翠 毛近平 习驴 拉清单 习大帝 赵家家仆 习##卡##巴##卡 恐惊天上人 习奥塞斯库、齐奥塞斯库 卡近菲 习Core 夶 A##Big##Deal 20000T麦子 西朝鲜人民自治岛 疯狂宇宙包 习king 墙内人 习总输记 毛二世 Heil##Xitler 疫情蔓延 总加速师 断崖式下跌 相信有神论的物理学博士 那翠化 席子兵法 “无罩”现身 万岁来武汉了 包惠帝 刁二将 二百斤 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 萨格尔王 《生物安全法》 习是春竹 叩谢习恩 习二二（二零二零年五月二十二日开二会） 截颈平 错误执行者 席近平 习尿瓶 包包大人 二百五大帝 韦来书记 蔡英文最强助选 习尽贫 颐使气指 习付 食腐虫 青年大学包 粪坑兵法 粪坑先生 小习微信 指定接班人 bingbang帝 普近 梁家河贵族 赵人13 迈克尔·索伊 庆丰帝的千秋梦 “复辟” 200吨 维尼挂彩 包子宪法 神明论 习奥赛斯库 吃赵弹 祈翠語言包 习瘟猪 法习斯 通商宽衣 乳透社##小反旗 刁近猴 没有网络安全就没有国家安全 习曱甴 玉习大帝 叩谢习恩 足球外交 刁近乎 读稿机 十一郎习近平 习三点 狙击手待命 巴拿马文件 戏博士 法外狂徒Lucy（德国） shuu##kinn##pei 共哀宗 中国的新皇帝 厕所革命 乳包文化 习得梁家书卷 领袖习澡水 Corona##Xi（习病毒） 老歪脖子树 大大品牌 时间控制 孤独的毒王 习二坐船 习二蛋 格萨尔 包子病毒 毛孙 习语 平&强 习索里尼 任大炮 终身领导人 没规划的葬礼 头上三尺有神明 维尼带货 刁人13 匪酋习维尼 阿平 两会期间+隐瞒 中字头组长 尼哥 次级乳包 习卒习 习包皮 爱新觉罗近平 中国爱非洲 习核心 */
package com.pcdd.sonovel.action;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.NumberUtil;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.core.Crawler;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.TocParser;
import com.pcdd.sonovel.util.ConfigUtils;
import lombok.AllArgsConstructor;

import java.util.List;
import java.util.Scanner;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2025/3/26
 */
@AllArgsConstructor
public class DownloadAction {

    private AppConfig config;
    public static final Scanner sc = Console.scanner();

    public void execute(List<SearchResult> results) {
        int num;
        int action;
        SearchResult sr;
        List<Chapter> toc;
        // 3. 选择下载章节
        while (true) {
            Console.print(render("==> 请输入下载序号（首列的数字，或输入 0 返回）：", "green"));
            String input = sc.nextLine().strip();
            // 健壮性判断：必须为数字
            try {
                num = Integer.parseInt(input);
            } catch (NumberFormatException e) {
                continue;
            }

            // 没有搜到想要的书，返回
            if (num == 0) return;
            // 健壮性判断：必须为首列的序号
            if (num < 0 || num > results.size()) continue;

            sr = results.get(num - 1);
            // 聚合搜索
            if (config == null) {
                config = ConfigUtils.config();
                config.setSourceId(sr.getSourceId());
            }
            Console.log("<== 正在获取章节目录 ...");
            TocParser tocParser = new TocParser(config);
            toc = tocParser.parse(sr.getUrl(), 1, Integer.MAX_VALUE);

            Console.log("<== 你选择了《{}》({})，共计 {} 章", sr.getBookName(), sr.getAuthor(), toc.size());
            Console.log("0: 重新选择功能");
            Console.log("1: 下载全本");
            Console.log("2: 下载指定范围章节");
            Console.log("3: 下载最新章节");
            Console.log("4: 重新输入序号");

            try {
                Console.print(render("==> 请输入序号：", "green"));
                action = Integer.parseInt(sc.nextLine());
            } catch (NumberFormatException e) {
                continue;
            }

            if (action != 4) break;
        }
        if (action == 0) return;
        if (action == 2) {
            try {
                Console.print(render("==> 请输起始章(最小为1)和结束章，用空格隔开：", "green"));
                String[] split = sc.nextLine().strip().split("\\s+");
                int start = Integer.parseInt(split[0]) - 1;
                int end = Integer.parseInt(split[1]);
                if (start > toc.size() || end > toc.size()) {
                    Console.log(render(StrUtil.format("超出章节范围，该小说共 {} 章", toc.size()), "yellow"));
                    return;
                }
                toc = CollUtil.sub(toc, start, end);
            } catch (Exception e) {
                return;
            }
        }
        if (action == 3) {
            try {
                Console.print(render("==> 请输入要下载最新章节的数量：", "green"));
                int i = Integer.parseInt(sc.nextLine());
                toc = CollUtil.sub(toc, toc.size() - i, toc.size());
            } catch (Exception e) {
                return;
            }
        }

        double res = new Crawler(config).crawl(sr, toc);
        Console.log("<== 完成！总耗时 {} s", NumberUtil.round(res, 2));
    }

}