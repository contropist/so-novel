/* 狙击手布阵 庆丰帝的千秋梦 系包皮 习奥塞斯库、齐奥塞斯库 “梦回大清” 骑巨龙 时间控制 Heil##Xitler 百万雄师事件 习得梁家书卷 一天游泳一千米 恐惊天上人 疯狂宇宙大帝 冲塔 疯狂宇宙包 基拉大和习近平 战“疫”金句 中国爱非洲 次级乳包 习歪嘴 “皇帝梦” 野兽先辈 颐指气使 維尼頌 习包皮 发皇帝梦 夶 独裁者 平&强 小学博士 习卒习 阿平 戴口赵 核平全世界 习总输记 毛孙 两会期间+隐瞒 讨习檄文 萨格尔王 习皇帝 大锅瞻遗 嬉包皮 Corona##Xi（习病毒） 不敢高声语 Adolf##Xitler 中国特色射秽煮疫制度 嘻包皮 包惠帝 口罩外交 习殡法 人类命运共同体首席架构师 维尼带货 劝进 习狍 习瘟猪 总统包子习 独裁国贼 战疫国 习猪席 沼气专家 习核心 武当七侠的政治斗争 人民战争 狙击手待命 WHO的君王 贬词包用 中国的新皇帝 维尼DISCO 包子露宪 老歪脖子树 中国离岸隐匿资产管理工作领导小组组组长 64岁 习大帝 梦回大清 甴种 崇祯 刁斤二 386系统驱动游戏 “登基” 云视察 习后主 阿道夫-习 外交习语 川普的朋友or敌人 金科律玉 扛麦郎 冠子兵法 追思焦裕禄 纳翠党 10号跳跳虎被维尼拉清单 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 游泳一千米 人尽皆知的体育迷 字共狗 主席贺词 习奥塞斯库 习索里尼 连专家也为之叹服的电脑天才 V尼哥 习king 添宪宝宝 刁二婚 习夶 通商宽衣 第22条军规 通商宽衣 狙击手待命 毛魔转世 乳透社##小反旗 甩锅侠 刁近猴 习兵法 动物庄园 习时代 超邓赶毛 毛进平 维尼连任 背书单 包子兵法 惜包皮 二百五大帝 秦城监狱 学包积极分子 总书记来我家 习公奭 包包侠 席子兵法 主席+终身制 九大诉求 坡涛汹涌 阳台上的哨兵 习大乞 富平学霸刁斤干 读书单 习猪下台 习家军 瘟疫降生习近平 习尿瓶 蔡英文最强助选 习匪帝 习大郎 大大品牌 太祖兔 习教父 集近闭 傻大头 习是春绿 20000T麦子 亲自指挥疫情 梁家河贵族 五毛主席 叩谢习恩 亲自脱贫 错误执行者 毛近平 老街 最后领导人 平平 习语录 席近平 倒车 坟头蹦迪 SB包子 shit侯 蹄防 习澳塞斯库 习匪 维尼熊 习付 习式病毒 包子病毒 支那毒王 二百斤 孤独的毒王 野心习 中字头组长 Cicada##3301##XD 央视姓党 禁评的理由 习近平光辉形象 氼兲嫑炛 virus##king 习一尊 世界最强乞丐 清华毕业 习孢子 中国首席造梦大师 食腐虫 闹得欢 毛泽东2.0 习厉王 习像章 世宗 维尼熊给跳跳虎黄牌 电脑世代586 坡涛汹涌 习二世胡亥 当皇帝的小丑 晚共昏君 “登机”（与登基同音） 赵弹 shuu##kinn##pei shit禁评 不知名氏 红二代 昆明湖涨潮 庆丰废物 亲自考察 天安门合法继承人 赵人13 包皇 恩维尔·霍习 平话 这个年很静 御板泽民 宰相 习下台 北京中南海支部书记 黄俄 学包分子 习壳郎 爱新觉罗·近平 习语 终身领导人 任志强 维尼快乐组织（Winnie##Happy##Organization）简称WHO 倒车帝 习梦撕 羽日帝 仲夏夜之中国梦 习宽衣 任大炮 耀眼黄红黄 孙笑川 颐使气指 裸宽包子劾心 维尼之声 刁远山 青年大学包 刁人13 中国拉清单工作领导小组组长 修宪连任 包禁评 “习泽东”和“洪宪”（袁世凯的帝号） 修宪 维尼梗有害 祈翠 猪禁评 集金pay 国王 习二卒 迈克尔·索伊 修宪帝 习侯 号尿壶公 韦来书记 第一书记王沪宁 习特勒 当代秦始皇 习博士 共哀宗 洗尽贫 扛麦帝 戏博士 習大佬 Mr##Shithole 親自視頻 习近砰 朝令夕改 维尼史 大撒币 非洲大撒币 帝皇頌 信女愿一生吃素 称帝修宪 2020全面小康 法外狂徒Lucy（德国） 影子末帝 习张三丰 习大 现任匪首 A##Big##Deal 官僚主义 武汉委托李克强 梦帝 满脸喷粪 习二坐船 宽衣大帝 断崖式下跌 尊蛤讨包 慨撒大帝 学包率 糟糕皇帝 十里山路不换肩 口罩大会 习##卡##巴##卡 XD 日子像蜜甜 习条英机 中国离岸隐匿资产管理工作领导小组组组长 习言乱语 包子宪法 彩色熊 腊肉馅儿包子 初二圣君 习习蛤蛤 彭主席（习主席走了太太接班） 宽衣帝 维持会长 清单帝 退党 包子金刚腿 维尼大帝 习禁评 大国造疫 粪坑先生 洗包皮 集金币 细瓶颈 当代秦二世 赵王 习老八 头号球迷 包大人 胡志平 皇帝亲临忠诚的武汉 “无罩”现身 习大犬 不同意的举手##没有##没有 皇帝梦 十一郎习近平 我是一个足球迷 屎禁评 習敗北 足球外交 野蛮其体魄 九评 神明论 bingbang帝 XDD xdd 厕所革命 习“甩锅” ChinaXi nmslese##dream 头上三尺有神明 皇帝的新衣 720事件 法习斯 NMSL 4中组长 恩重如删 维尼挂彩 乳制品 瘟疫领主习近平 刁斤山 巴拿马文件 红旗下的蛋 习流氓 西朝鲜人民自治岛 包经 没规划的葬礼 禁评封号 格萨尔 尼哥 庆丰包·勃列日涅夫 疯狂宇宙 维尼·屎(Winnie##the##Poo) 习是春竹 万岁 鞋哥 岿然不动 习猪头 墨索里习 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习包子 总加速师 爱新觉罗近平 大海掀翻小池塘 维尼警察（X） 末代皇帝 玉习大帝 人民领袖 你是反贼吗 习呆呆 屎侯 孢 习低能儿 大大招牌 民进党 喜包皮 赛禁评 书单吟诵者 邪大大 细颈瓶 屎進瓶 刁大犬 每日祈翠 维尼写史 指定接班人 国贼习近平 赵付 人民领袖 袭包皮 习王的田野上 东瘟疫之地统治者暨全境守护者 无限连任 万岁来武汉 Criminal##Xi##"Xitler"##Jinping 支那精神野爹 截颈平 北红尾鸲 包包大人 十日文革 近日成 刁二将 崇祯帝 野兽主席 读稿机 二次袁、袁世凯二世、袁二 拉清单 塔西佗陷阱 习梦思 疫情蔓延 祈翠語言包 花花公子 裹嘎举吸钢闸门 习武帝 近身平A 习二二（二零二零年五月二十二日开二会） 糖尿维尼 东方project 普习金 做N届的主席 万岁来武汉了 亲自封号 新影帝 亲自指挥 习emperor 墙内人 喷粪帝 灭共助推器 近言 捐麦子 习曱甴 习奥赛斯库 普近 吃赵弹 翡翠娘娘 独彩者 “黄袍加身” 包帝巡游 《生物安全法》 悉包皮 electron8964 清零宗、清零帝 赵家家仆 一带一路 习总 感恩教育 黑白翠 重地之战 习尔布特 刁后主 武统时代 儿童习典 习包子 总书记来过我的家 相信有神论的物理学博士 冤大头 半羽习近平 乳包文化 冰棒外交 没有网络安全就没有国家安全 毛二习 习梦死 习驴 Voice##of##Pooh 毛二 親自蒞臨 习皇的新装 习大林 毛二世 形式主义防疫 习病法 习贼 戏包皮 䒒(tiáo)菦(qín)苹(píng) 大兔 刁近乎 nmslman（习主席） 卡近菲 习屎黄 习二胖 领袖习澡水 习二蛋 习包子 文明其精神 甴近平 吸包皮 匪酋习维尼 彩色哥 役民五术 维稳警察（O） 隔离”的金葫芦 习躲躲 毛装 习思想 吸精瓶 袁世凯第二 习尽贫 习蛤 家业论 习废帝 The##Xi##Factor（习近平因素） 动物森友会 庆丰称帝 叼斤干 号屎洞 哲欣 习Core Chairman##Xi 不强自息 送礼平 腊肉包 刁人13 小习微信 CoronaXi 专治各种不服 习和谐 亲自删评 梁家河 撒币宝 灰习牛 习进棺 习远凸 习卒 习达姆 习包子的Fa 枪毙名单 习背书 白猪 习犬犬 叩谢习恩 刁槑夶尛 习三拍 抗麦套装 公车上书 那翠化 vop 小学居士 习太孑 倒车斯基 习正日 视频看望 習敗敗 大撒幣 共哀宗 智商不重要 动物之森 shit##hole##bing##fa 粪坑兵法 “复辟” 人均接近八千万 动森 习三点 200吨 假.."~bang！卒 皇帝亲临忠诚的武汉 禁评大帝 */
package com.pcdd.sonovel.action;

import cn.hutool.core.convert.Convert;
import cn.hutool.core.date.DateUtil;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.NumberUtil;
import cn.hutool.core.util.StrUtil;
import com.pcdd.sonovel.core.Crawler;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.SearchParser;
import com.pcdd.sonovel.parse.TocParser;
import lombok.AllArgsConstructor;

import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2025/2/21
 */
@AllArgsConstructor
public class BatchDownloadAction {

    private final AppConfig config;
    public static final String DIVIDER = "=".repeat(50);

    public void execute() {
        Scanner sc = Console.scanner();
        List<String> lines = new ArrayList<>();
        Console.log(render("==> 请依次输入书名和作者，用空格隔开，每输入一条按回车。输入 # 结束: ", "green"));
        while (true) {
            String line = sc.nextLine();
            if ("#".equals(line.strip())) {
                break;
            }
            if (StrUtil.isNotEmpty(line)) {
                lines.add(line);
            }
        }

        SearchParser sp = new SearchParser(config);
        List<SearchResult> downloadList = new ArrayList<>();
        StringBuilder notFound = new StringBuilder();

        for (String line : lines) {
            String[] split = line.split("\\s+");
            String bookName = split[0];
            String author = split[1];
            List<SearchResult> res = sp.parse(bookName, true);
            res.stream()
                    .filter(sr -> bookName.equals(sr.getBookName()) && author.equals(sr.getAuthor()))
                    .findFirst()
                    .ifPresentOrElse(sr -> {
                        Console.log("<== 已找到：《{}》({}) {}", sr.getBookName(), sr.getAuthor(), sr.getUrl());
                        downloadList.add(sr);
                    }, () -> {
                        Console.log("<== 未找到：《{}》({})", bookName, author);
                        notFound.append(bookName).append(" ").append(author).append("\n");
                    });
        }

        Console.log("<== 共计 {} 本，已找到 {} 本，未找到 {} 本", lines.size(), downloadList.size(), lines.size() - downloadList.size());
        // 一本书也没有搜到
        if (downloadList.isEmpty()) {
            return;
        }
        // 存在未搜到的书
        if (!notFound.isEmpty()) {
            notFound.append("#\n");
            notFound.append("若要继续下载上述未搜到的书: 切换其它书源，复制以上内容，粘贴到批量下载，以此类推……\n");
            FileUtil.writeUtf8String(notFound.toString(),
                    System.getProperty("user.dir") + File.separator + "批量下载 - 书源 %s 未搜到的书.log".formatted(config.getSourceId()));
        }
        Console.print(render("==> 输入 Y 以确认下载：", "green"));
        if ("Y".equalsIgnoreCase(sc.next().strip())) {
            double totalTime = 0;
            TocParser tocParser = new TocParser(config);

            for (int i = 0; i < downloadList.size(); i++) {
                SearchResult sr = downloadList.get(i);
                String logTemplate = StrUtil.format(DIVIDER + " %s 《{}》({}) 进度: {}/{} " + DIVIDER,
                        sr.getBookName(), sr.getAuthor(), i + 1, downloadList.size());
                Console.log("\n" + logTemplate.formatted("START"));
                List<Chapter> toc = tocParser.parse(sr.getUrl(), 1, Integer.MAX_VALUE);
                double res = new Crawler(config).crawl(sr, toc);
                Console.log("<== 完成！总耗时 {} s", NumberUtil.round(res, 2));
                Console.log(logTemplate.formatted("END") + "\n");
                totalTime += res;
            }

            Console.log("<== 批量下载完成！总耗时 {}\n", DateUtil.formatBetween(Convert.toLong(totalTime * 1000)));
        }
    }

}