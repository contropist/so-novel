/* 戴口赵 十一郎习近平 Criminal##Xi##"Xitler"##Jinping 习贼 《生物安全法》 当代秦始皇 习二卒 粪坑兵法 红旗下的蛋 退党 毛二习 甴种 习言乱语 梦帝 宽衣大帝 邪大大 巴拿马文件 文明其精神 毛魔转世 中国爱非洲 “皇帝梦” CoronaXi 万岁 皇帝亲临忠诚的武汉 世宗 Heil##Xitler 嘻包皮 赛禁评 刁斤山 刁斤二 习二胖 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习一尊 习大帝 疯狂宇宙 冰棒外交 倒车帝 中国拉清单工作领导小组组长 “习泽东”和“洪宪”（袁世凯的帝号） Chairman##Xi 毛二世 夶 维尼梗有害 习三点 总书记来我家 386系统驱动游戏 阳台上的哨兵 刁近猴 中国离岸隐匿资产管理工作领导小组组组长 黄俄 习奥赛斯库 喜包皮 戏博士 背书单 青年大学包 中国离岸隐匿资产管理工作领导小组组组长 习驴 你是反贼吗 乳包文化 习大林 “登机”（与登基同音） 习歪嘴 公车上书 “梦回大清” 冤大头 习emperor 大国造疫 庆丰废物 亲自指挥 灰习牛 包帝巡游 狙击手待命 习背书 习大犬 大兔 万岁来武汉了 核平全世界 赵人13 二次袁、袁世凯二世、袁二 次级乳包 崇祯 习索里尼 支那毒王 游泳一千米 我是一个足球迷 扛麦帝 糟糕皇帝 厕所革命 讨习檄文 初二圣君 云视察 人民领袖 刁槑夶尛 隔离”的金葫芦 重地之战 总加速师 喷粪帝 人民战争 御板泽民 XD 花花公子 梦回大清 親自視頻 皇帝的新衣 冲塔 习教父 颐使气指 吃赵弹 翡翠娘娘 10号跳跳虎被维尼拉清单 粪坑先生 恩重如删 朝令夕改 时间控制 现任匪首 習敗北 习思想 傻大头 刁人13 习核心 孢 包惠帝 读书单 民进党 墨索里习 两会期间+隐瞒 总统包子习 习壳郎 糖尿维尼 亲自指挥疫情 拉清单 战“疫”金句 九评 近日成 闹得欢 人类命运共同体首席架构师 连专家也为之叹服的电脑天才 号屎洞 V尼哥 维尼熊给跳跳虎黄牌 刁远山 悉包皮 毛进平 新影帝 不知名氏 孙笑川 法外狂徒Lucy（德国） 二百斤 20000T麦子 习下台 习奥塞斯库 习匪 禁评大帝 nmslman（习主席） 包子宪法 动物之森 shuu##kinn##pei 习猪下台 役民五术 屎進瓶 庆丰帝的千秋梦 主席贺词 黑白翠 耀眼黄红黄 习屎黄 大海掀翻小池塘 习蛤 习禁评 毛装 慨撒大帝 习兵法 习尽贫 习大郎 毛近平 氼兲嫑炛 习习蛤蛤 五毛主席 习“甩锅” 国王 官僚主义 维尼连任 习公奭 习包子 平&强 720事件 习奥塞斯库、齐奥塞斯库 甴近平 习梦死 习尿瓶 亲自封号 老街 习殡法 二百五大帝 第22条军规 恩维尔·霍习 百万雄师事件 包大人 中字头组长 清零宗、清零帝 羽日帝 骑巨龙 包包侠 北红尾鸲 习澳塞斯库 集近闭 小习微信 秦城监狱 野兽主席 韦来书记 裸宽包子劾心 崇祯帝 习是春绿 捐麦子 末代皇帝 The##Xi##Factor（习近平因素） 视频看望 洗包皮 64岁 习大乞 匪酋习维尼 屎禁评 智商不重要 书单吟诵者 不强自息 大撒幣 非洲大撒币 主席+终身制 Corona##Xi（习病毒） 无限连任 刁大犬 感恩教育 习孢子 错误执行者 xdd 习躲躲 尼哥 仲夏夜之中国梦 头号球迷 蹄防 天安门合法继承人 小学居士 大大招牌 修宪 包皇 习皇的新装 口罩外交 共哀宗 梁家河 腊肉包 学包积极分子 集金pay 腊肉馅儿包子 惜包皮 习卒习 “复辟” 习匪帝 习狍 枪毙名单 习梦撕 修宪连任 习博士 那翠化 添宪宝宝 爱新觉罗·近平 萨格尔王 日子像蜜甜 野兽先辈 习侯 最后领导人 习流氓 习像章 没规划的葬礼 䒒(tiáo)菦(qín)苹(píng) 皇帝梦 席近平 断崖式下跌 央视姓党 食腐虫 习废帝 近身平A WHO的君王 家业论 习包子 太祖兔 维尼之声 终身领导人 阿道夫-习 2020全面小康 XDD 习付 倒车斯基 习得梁家书卷 叼斤干 习总输记 追思焦裕禄 维尼警察（X） 倒车 世界最强乞丐 帝皇頌 甩锅侠 大大品牌 宽衣帝 习三拍 撒币宝 动物森友会 坡涛汹涌 细颈瓶 系包皮 中国首席造梦大师 皇帝亲临忠诚的武汉 狙击手待命 共哀宗 刁二将 爱新觉罗近平 习包子 普习金 野蛮其体魄 墙内人 沼气专家 格萨尔 玉习大帝 庆丰包·勃列日涅夫 塔西佗陷阱 大撒币 截颈平 virus##king 修宪帝 乳制品 习瘟猪 习张三丰 毛二 习总 习进棺 禁评的理由 学包率 影子末帝 孤独的毒王 包禁评 习猪席 习后主 习是春竹 西朝鲜人民自治岛 疯狂宇宙包 习二二（二零二零年五月二十二日开二会） 习低能儿 包经 包子金刚腿 “登基” 平话 东方project Adolf##Xitler 习宽衣 疫情蔓延 瘟疫降生习近平 包包大人 习和谐 当皇帝的小丑 任大炮 洗尽贫 刁近乎 习式病毒 冠子兵法 习条英机 维尼挂彩 阿平 通商宽衣 清单帝 学包分子 习猪头 习皇帝 武统时代 习特勒 4中组长 shit侯 親自蒞臨 读稿机 疯狂宇宙大帝 习病法 习太孑 送礼平 颐指气使 昆明湖涨潮 号尿壶公 维尼史 独裁者 尊蛤讨包 十日文革 鞋哥 庆丰称帝 袭包皮 基拉大和习近平 字共狗 近言 武汉委托李克强 贬词包用 屎侯 习卒 神明论 国贼习近平 习大 万岁来武汉 卡近菲 习曱甴 袁世凯第二 vop 恐惊天上人 相信有神论的物理学博士 晚共昏君 维尼·屎(Winnie##the##Poo) 哲欣 赵付 平平 外交习语 第一书记王沪宁 彩色熊 shit##hole##bing##fa 头上三尺有神明 白猪 总书记来过我的家 习二世胡亥 nmslese##dream 刁人13 Voice##of##Pooh 口罩大会 习Core 习老八 毛泽东2.0 习呆呆 ChinaXi 亲自考察 富平学霸刁斤干 毛孙 人民领袖 叩谢习恩 独彩者 金科律玉 超邓赶毛 习犬犬 十里山路不换肩 维稳警察（O） 东瘟疫之地统治者暨全境守护者 Mr##Shithole 领袖习澡水 支那精神野爹 红二代 习##卡##巴##卡 独裁国贼 劝进 electron8964 假.."~bang！卒 习家军 维尼熊 吸包皮 包子露宪 野心习 習大佬 岿然不动 一带一路 做N届的主席 九大诉求 赵弹 武当七侠的政治斗争 北京中南海支部书记 裹嘎举吸钢闸门 “无罩”现身 习二坐船 动物庄园 嬉包皮 习king 包子病毒 赵家家仆 狙击手布阵 细瓶颈 大锅瞻遗 人尽皆知的体育迷 维尼带货 抗麦套装 习梦思 200吨 习夶 没有网络安全就没有国家安全 禁评封号 亲自脱贫 法习斯 戏包皮 习王的田野上 shit禁评 席子兵法 叩谢习恩 习时代 老歪脖子树 习语录 刁二婚 維尼頌 称帝修宪 灭共助推器 动森 亲自删评 维持会长 习正日 刁后主 习包子的Fa 彩色哥 猪禁评 不敢高声语 蔡英文最强助选 形式主义防疫 这个年很静 满脸喷粪 NMSL 习近砰 中国的新皇帝 不同意的举手##没有##没有 坡涛汹涌 发皇帝梦 普近 电脑世代586 bingbang帝 习二蛋 乳透社##小反旗 习远凸 纳翠党 习尔布特 维尼DISCO 半羽习近平 习达姆 习武帝 习厉王 宰相 小学博士 当代秦二世 SB包子 一天游泳一千米 每日祈翠 人均接近八千万 Cicada##3301##XD 包子兵法 祈翠 胡志平 足球外交 瘟疫领主习近平 专治各种不服 祈翠語言包 川普的朋友or敌人 扛麦郎 习语 战疫国 儿童习典 梁家河贵族 信女愿一生吃素 坟头蹦迪 指定接班人 迈克尔·索伊 吸精瓶 “黄袍加身” A##Big##Deal 習敗敗 习近平光辉形象 任志强 通商宽衣 维尼写史 习包皮 维尼快乐组织（Winnie##Happy##Organization）简称WHO 赵王 中国特色射秽煮疫制度 维尼大帝 清华毕业 彭主席（习主席走了太太接班） 集金币 */
package com.pcdd.sonovel.action;

import cn.hutool.core.comparator.VersionComparator;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.io.StreamProgress;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.StrUtil;
import cn.hutool.http.Header;
import cn.hutool.http.HttpResponse;
import cn.hutool.http.HttpUtil;
import cn.hutool.json.JSONArray;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;
import cn.hutool.setting.dialect.Props;
import cn.hutool.system.OsInfo;
import cn.hutool.system.SystemUtil;
import com.pcdd.sonovel.util.ConfigUtils;
import com.pcdd.sonovel.util.FileUtils;
import com.pcdd.sonovel.util.RandomUA;
import me.tongfei.progressbar.ProgressBar;
import me.tongfei.progressbar.ProgressBarStyle;

import java.io.File;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2024/11/10
 */
public class CheckUpdateAction {

    public static final String GHP = "https://ghproxy.net/";
    public static final String RELEASE_URL = "https://api.github.com/repos/freeok/so-novel/releases";
    public static final String ASSETS_URL = "https://github.com/freeok/so-novel/releases/download/{}/sonovel-{}.tar.gz";
    private final int timeoutMills;

    public CheckUpdateAction() {
        this.timeoutMills = 5_000;
    }

    public CheckUpdateAction(int timeout) {
        this.timeoutMills = timeout;
    }

    public void execute() {
        Console.log("<== 检查更新中...");

        try (HttpResponse resp = HttpUtil.createGet(RELEASE_URL)
                .timeout(timeoutMills)
                .header(Header.USER_AGENT, RandomUA.generate())
                .execute()) {

            Props sys = ConfigUtils.sys();
            String jsonStr = resp.body();
            JSONArray arr = JSONUtil.parseArray(jsonStr);
            JSONObject latest = JSONUtil.parseObj(arr.get(0));
            // v1.7.0
            String currentVersion = "v" + sys.getStr("version");
            // v1.7.0-beta.2
            String latestVersion = latest.get("tag_name", String.class);
            String latestUrl = latest.get("html_url", String.class);

            if (VersionComparator.INSTANCE.compare(currentVersion, latestVersion) < 0) {
                Console.log("<== 发现新版本: {} ({})", latestVersion, latestUrl);
                download(getDownloadUrl(latestVersion));
            } else {
                Console.log("<== {} 已是最新版本！({})", latestVersion, latestUrl);
            }
        } catch (Exception e) {
            Console.log(render("\n<== 更新失败，当前网络环境无法访问 GitHub，请稍后再试 ({})", "red"), e.getMessage());
        }
    }

    private String getDownloadUrl(String version) {
        OsInfo osInfo = SystemUtil.getOsInfo();
        String osName = osInfo.getName();
        String arch = osInfo.getArch();
        String fileName = "windows";

        if (osName.contains("Windows")) {
            fileName = "windows";
        } else if (osName.contains("Mac")) {
            // 根据架构进一步细分
            fileName = "aarch64".equals(arch) ? "macos_arm64" : "macos_x64";
        } else if (osName.contains("Linux")) {
            fileName = "linux";
        }

        return GHP + StrUtil.format(ASSETS_URL, version, fileName);
    }

    private void download(String url) {
        // 预获取文件大小
        long fileSize = FileUtils.fileSize(url);
        // 设置进度条
        ProgressBar bar = ProgressBar.builder()
                .setTaskName("Downloading new version")
                .setInitialMax(fileSize)
                .setStyle(ProgressBarStyle.ASCII)
                .setMaxRenderedLength(100)
                .setUpdateIntervalMillis(10)
                .build();
        //  下载到上一级路径
        File file = new File(System.getProperty("user.dir")).getParentFile();

        // 带进度显示的文件下载
        HttpUtil.downloadFile(url, file, new StreamProgress() {
            @Override
            public void start() {
                bar.setExtraMessage("Downloading ...");
            }

            @Override
            public void progress(long total, long read) {
                // 更新进度条
                bar.stepTo(read);
            }

            @Override
            public void finish() {
                bar.setExtraMessage("Done!");
            }
        });

        bar.close();
        Console.log("<== 下载位置: {}", file + File.separator + FileUtil.getName(url));
    }

}