/* 坡涛汹涌 甴种 晚共昏君 共哀宗 连专家也为之叹服的电脑天才 习家军 读书单 梦回大清 当代秦始皇 维尼熊 nmslman（习主席） A##Big##Deal 糖尿维尼 野兽主席 4中组长 叩谢习恩 小学博士 刁大犬 闹得欢 习三拍 ChinaXi 习包皮 氼兲嫑炛 鞋哥 习侯 毛孙 时间控制 习emperor 恩重如删 蔡英文最强助选 刁后主 不敢高声语 刁槑夶尛 翡翠娘娘 无限连任 习“甩锅” 习索里尼 习兵法 “黄袍加身” 狙击手待命 儿童习典 灰习牛 习梦撕 喜包皮 第一书记王沪宁 习二二（二零二零年五月二十二日开二会） 冠子兵法 宰相 假.."~bang！卒 半羽习近平 中国拉清单工作领导小组组长 亲自脱贫 修宪帝 武汉委托李克强 通商宽衣 习大 bingbang帝 近身平A 国贼习近平 禁评大帝 电脑世代586 抗麦套装 维尼熊给跳跳虎黄牌 中国的新皇帝 发皇帝梦 尼哥 叼斤干 添宪宝宝 “复辟” 祈翠 动物之森 墙内人 CoronaXi 末代皇帝 平&强 維尼頌 赵弹 平话 书单吟诵者 习废帝 韦来书记 习式病毒 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 你是反贼吗 袭包皮 次级乳包 宽衣帝 习武帝 黑白翠 習大佬 习梦思 䒒(tiáo)菦(qín)苹(píng) 200吨 小学居士 习尿瓶 修宪 食腐虫 乳制品 亲自封号 习包子 习老八 包子宪法 捐麦子 猪禁评 XDD 习奥塞斯库 席子兵法 孤独的毒王 禁评的理由 刁近乎 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 习总 庆丰包·勃列日涅夫 赵家家仆 习一尊 親自蒞臨 习狍 官僚主义 “登基” 武当七侠的政治斗争 拉清单 The##Xi##Factor（习近平因素） 习犬犬 一天游泳一千米 习奥赛斯库 親自視頻 新影帝 老街 甩锅侠 任大炮 倒车帝 昆明湖涨潮 包帝巡游 维持会长 “登机”（与登基同音） 包子金刚腿 包子病毒 习进棺 叩谢习恩 孙笑川 “无罩”现身 戏博士 习猪席 中国离岸隐匿资产管理工作领导小组组组长 做N届的主席 习得梁家书卷 屎進瓶 维尼大帝 洗尽贫 称帝修宪 独裁者 屎禁评 皇帝的新衣 2020全面小康 vop 刁人13 包大人 不知名氏 十日文革 裹嘎举吸钢闸门 御板泽民 习宽衣 习背书 二次袁、袁世凯二世、袁二 习核心 shit侯 维尼挂彩 讨习檄文 集近闭 糟糕皇帝 撒币宝 包包大人 万岁来武汉 格萨尔 刁近猴 小习微信 習敗敗 法习斯 NMSL 习奥塞斯库、齐奥塞斯库 庆丰称帝 感恩教育 维尼史 shit禁评 中国特色射秽煮疫制度 号尿壶公 习流氓 20000T麦子 人均接近八千万 毛二世 习是春竹 腊肉包 包皇 习近平光辉形象 爱新觉罗·近平 阿平 东瘟疫之地统治者暨全境守护者 习包子 羽日帝 慨撒大帝 玉习大帝 总书记来我家 习禁评 维稳警察（O） 学包分子 耀眼黄红黄 10号跳跳虎被维尼拉清单 彩色哥 皇帝亲临忠诚的武汉 大海掀翻小池塘 习尔布特 维尼·屎(Winnie##the##Poo) 动物森友会 宽衣大帝 总统包子习 我是一个足球迷 口罩外交 太祖兔 习包子 黄俄 学包积极分子 赵王 独彩者 九评 大兔 嘻包皮 初二圣君 战疫国 断崖式下跌 东方project 习卒 中字头组长 追思焦裕禄 Chairman##Xi 习大林 胡志平 世宗 维尼写史 中国离岸隐匿资产管理工作领导小组组组长 口罩大会 electron8964 SB包子 习夶 阳台上的哨兵 邪大大 习近砰 倒车斯基 赛禁评 老歪脖子树 大大品牌 習敗北 九大诉求 清华毕业 习条英机 习下台 习二胖 习三点 亲自考察 集金pay 毛泽东2.0 任志强 外交习语 爱新觉罗近平 北红尾鸲 习言乱语 塔西佗陷阱 民进党 颐使气指 岿然不动 号屎洞 墨索里习 清单帝 国王 世界最强乞丐 袁世凯第二 野蛮其体魄 匪酋习维尼 崇祯帝 重地之战 卡近菲 总加速师 亲自指挥疫情 修宪连任 皇帝亲临忠诚的武汉 习远凸 形式主义防疫 公车上书 花花公子 屎侯 视频看望 赵付 当皇帝的小丑 习包子的Fa 包包侠 冲塔 习思想 习厉王 shit##hole##bing##fa 富平学霸刁斤干 包经 梦帝 亲自删评 维尼带货 中国爱非洲 惜包皮 习教父 学包率 习习蛤蛤 疫情蔓延 劝进 大大招牌 集金币 戴口赵 习二蛋 戏包皮 刁二婚 迈克尔·索伊 习达姆 喷粪帝 悉包皮 习澳塞斯库 主席+终身制 纳翠党 白猪 习曱甴 刁远山 习二世胡亥 xdd 大国造疫 普近 Corona##Xi（习病毒） 维尼之声 人民领袖 扛麦帝 粪坑先生 没规划的葬礼 习梦死 习猪头 坡涛汹涌 二百五大帝 习特勒 帝皇頌 第22条军规 非洲大撒币 习皇的新装 恐惊天上人 字共狗 包子兵法 习像章 这个年很静 野心习 领袖习澡水 腊肉馅儿包子 万岁来武汉了 习##卡##巴##卡 退党 近日成 没有网络安全就没有国家安全 那翠化 独裁国贼 二百斤 习二坐船 习歪嘴 背书单 习王的田野上 总书记来过我的家 亲自指挥 不同意的举手##没有##没有 “皇帝梦” 皇帝梦 virus##king 赵人13 文明其精神 红二代 信女愿一生吃素 Mr##Shithole 隔离”的金葫芦 天安门合法继承人 尊蛤讨包 习卒习 两会期间+隐瞒 刁人13 洗包皮 西朝鲜人民自治岛 习病法 毛装 普习金 孢 乳透社##小反旗 习语 吃赵弹 大锅瞻遗 傻大头 720事件 习皇帝 枪毙名单 头号球迷 截颈平 满脸喷粪 颐指气使 役民五术 习大帝 毛二 影子末帝 一带一路 维尼警察（X） 夶 清零宗、清零帝 包禁评 “习泽东”和“洪宪”（袁世凯的帝号） 神明论 仲夏夜之中国梦 习壳郎 XD 毛魔转世 超邓赶毛 维尼梗有害 习呆呆 习正日 粪坑兵法 庆丰帝的千秋梦 秦城监狱 专治各种不服 送礼平 维尼DISCO 北京中南海支部书记 64岁 彩色熊 厕所革命 习匪 疯狂宇宙包 足球外交 五毛主席 灭共助推器 Voice##of##Pooh 祈翠語言包 席近平 习二卒 倒车 习博士 十一郎习近平 WHO的君王 人尽皆知的体育迷 人类命运共同体首席架构师 大撒幣 日子像蜜甜 狙击手布阵 近言 习语录 习躲躲 青年大学包 百万雄师事件 头上三尺有神明 智商不重要 细颈瓶 Criminal##Xi##"Xitler"##Jinping shuu##kinn##pei 核平全世界 阿道夫-习 贬词包用 维尼连任 习后主 吸精瓶 疯狂宇宙 云视察 瘟疫降生习近平 习张三丰 游泳一千米 nmslese##dream 细瓶颈 武统时代 刁斤山 恩维尔·霍习 万岁 动森 毛二习 乳包文化 裸宽包子劾心 习总输记 哲欣 习屎黄 习孢子 当代秦二世 中国首席造梦大师 指定接班人 家业论 瘟疫领主习近平 “梦回大清” Cicada##3301##XD 川普的朋友or敌人 冰棒外交 V尼哥 平平 习是春绿 禁评封号 央视姓党 动物庄园 包惠帝 Adolf##Xitler 梁家河 坟头蹦迪 刁斤二 人民战争 萨格尔王 庆丰废物 不强自息 习公奭 每日祈翠 狙击手待命 错误执行者 十里山路不换肩 法外狂徒Lucy（德国） 蹄防 终身领导人 习贼 《生物安全法》 维尼快乐组织（Winnie##Happy##Organization）简称WHO 通商宽衣 崇祯 读稿机 战“疫”金句 习猪下台 现任匪首 支那精神野爹 系包皮 吸包皮 巴拿马文件 人民领袖 主席贺词 冤大头 扛麦郎 习殡法 野兽先辈 梁家河贵族 朝令夕改 Heil##Xitler 习大犬 习时代 大撒币 习驴 基拉大和习近平 习大乞 习低能儿 386系统驱动游戏 习Core 彭主席（习主席走了太太接班） 最后领导人 共哀宗 刁二将 包子露宪 金科律玉 习太孑 嬉包皮 习尽贫 支那毒王 毛近平 习king 习和谐 毛进平 习蛤 习大郎 习匪帝 习瘟猪 红旗下的蛋 疯狂宇宙大帝 习付 骑巨龙 沼气专家 甴近平 相信有神论的物理学博士 */
package com.pcdd.sonovel.action;

import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.ConsoleTable;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.Rule;
import com.pcdd.sonovel.model.SourceInfo;
import com.pcdd.sonovel.util.OkHttpUtils;
import com.pcdd.sonovel.util.RandomUA;
import com.pcdd.sonovel.util.SourceUtils;
import lombok.SneakyThrows;
import okhttp3.OkHttpClient;
import okhttp3.Request;
import okhttp3.Response;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletionService;
import java.util.concurrent.ExecutorCompletionService;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static org.jline.jansi.AnsiRenderer.render;

/**
 * 书源一览
 *
 * @author pcdd
 * Created at 2025/1/9
 */
public class ShowSourcesAction {

    public void execute() {
        Console.log("<== 测试延迟中 ...");

        ConsoleTable asciiTables = ConsoleTable.create()
                .setSBCMode(false)
                .addHeader("ID", "书源", "延迟", "状态码", "URL");
        List<Rule> rules = SourceUtils.ALL_IDS.stream()
                .map(id -> new Source(id).rule)
                .toList();

        testWebsiteDelays(rules).forEach(e -> asciiTables.addBody(
                e.getId() + "",
                e.getName(),
                e.getDelay() + " ms",
                e.getCode() + "",
                e.getUrl())
        );

        Console.table(asciiTables);
    }

    @SneakyThrows
    private static List<SourceInfo> testWebsiteDelays(List<Rule> rules) {
        List<SourceInfo> res = new ArrayList<>();
        ExecutorService threadPool = Executors.newFixedThreadPool(rules.size());
        CompletionService<SourceInfo> completionService = new ExecutorCompletionService<>(threadPool);
        OkHttpClient client = OkHttpUtils.createUnsafeClient();

        for (Rule r : rules) {
            completionService.submit(() -> {
                SourceInfo source = SourceInfo.builder()
                        .id(r.getId())
                        .name(r.getName())
                        .url(r.getUrl())
                        .build();
                try {
                    Request req = new Request.Builder()
                            .url(r.getUrl())
                            .header("User-Agent", RandomUA.generate())
                            .head() // 只发 HEAD 请求，不获取 body，更快！
                            .build();
                    // 放这里才最准确
                    long startTime = System.currentTimeMillis();
                    try (Response resp = client.newCall(req).execute()) {
                        source.setDelay((int) (System.currentTimeMillis() - startTime));
                        source.setCode(resp.code());
                    }
                } catch (Exception e) {
                    source.setDelay(-1);
                    source.setCode(-1);
                    if (System.getProperty("env").equalsIgnoreCase("dev")) {
                        Console.error(render("书源 {} 【{}】 测试延迟异常：{}", "red"), r.getId(), r.getName(), e.getMessage());
                    }
                }

                return source;
            });
        }

        for (int i = 0; i < rules.size(); i++) {
            // 获取最先完成的任务的结果
            res.add(completionService.take().get());
        }

        threadPool.shutdown();

        res.sort((o1, o2) -> {
            int delay1 = o1.getDelay() < 0 ? Integer.MAX_VALUE : o1.getDelay();
            int delay2 = o2.getDelay() < 0 ? Integer.MAX_VALUE : o2.getDelay();
            return Integer.compare(delay1, delay2);
        });

        return res;
    }

}