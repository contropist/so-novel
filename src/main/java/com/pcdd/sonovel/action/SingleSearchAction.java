/* 送礼平 Mr##Shithole 灭共助推器 习公奭 XDD 维尼写史 字共狗 习大帝 习皇的新装 花花公子 Chairman##Xi 战“疫”金句 中国的新皇帝 刁二将 电脑世代586 宰相 习付 习躲躲 清华毕业 习包皮 习猪头 胡志平 席近平 爱新觉罗·近平 习包子 冲塔 东瘟疫之地统治者暨全境守护者 百万雄师事件 禁评的理由 彩色哥 末代皇帝 野兽主席 2020全面小康 集金pay 维尼带货 近日成 习“甩锅” 习梦死 亲自删评 狙击手布阵 秦城监狱 终身领导人 刁大犬 习近平光辉形象 习殡法 世宗 刁后主 孢 ChinaXi nmslman（习主席） 习得梁家书卷 习是春绿 坡涛汹涌 倒车 刁斤山 包皇 习兵法 蔡英文最强助选 親自視頻 纳翠党 禁评封号 习言乱语 shit侯 五毛主席 清零宗、清零帝 普近 习语 邪大大 通商宽衣 親自蒞臨 口罩大会 枪毙名单 疫情蔓延 刁近乎 “无罩”现身 包大人 屎侯 九大诉求 万岁来武汉了 神明论 皇帝亲临忠诚的武汉 包惠帝 足球外交 习总输记 习二胖 朝令夕改 韦来书记 坡涛汹涌 红二代 二百斤 “习泽东”和“洪宪”（袁世凯的帝号） 64岁 习远凸 刁人13 修宪帝 习禁评 颐使气指 Adolf##Xitler 老街 悉包皮 独裁者 没规划的葬礼 庆丰包·勃列日涅夫 十里山路不换肩 夶 小习微信 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 人民战争 习包子 习家军 初二圣君 集近闭 称帝修宪 习索里尼 核平全世界 皇帝的新衣 学包率 白猪 西朝鲜人民自治岛 維尼頌 北京中南海支部书记 4中组长 独裁国贼 习大犬 刁二婚 vop 独彩者 习语录 细颈瓶 抗麦套装 习皇帝 大撒币 读书单 叩谢习恩 战疫国 毛近平 主席+终身制 维尼史 家业论 习奥塞斯库 裸宽包子劾心 戴口赵 10号跳跳虎被维尼拉清单 喜包皮 疯狂宇宙 shit##hole##bing##fa 冠子兵法 主席贺词 习正日 习式病毒 习三点 崇祯 哲欣 惜包皮 时间控制 维尼警察（X） 瘟疫领主习近平 不强自息 中国离岸隐匿资产管理工作领导小组组组长 720事件 坟头蹦迪 捐麦子 退党 野心习 红旗下的蛋 A##Big##Deal 基拉大和习近平 头号球迷 习下台 当代秦始皇 人尽皆知的体育迷 bingbang帝 爱新觉罗近平 习歪嘴 386系统驱动游戏 习病法 隔离”的金葫芦 墙内人 习emperor 习老八 袭包皮 习尽贫 包帝巡游 “皇帝梦” 文明其精神 做N届的主席 亲自指挥疫情 亲自指挥 细瓶颈 公车上书 武统时代 习侯 彭主席（习主席走了太太接班） 无限连任 梦帝 北红尾鸲 毛装 总书记来我家 疯狂宇宙大帝 平平 习进棺 添宪宝宝 武当七侠的政治斗争 超邓赶毛 背书单 习是春竹 鞋哥 号屎洞 习匪 shuu##kinn##pei 形式主义防疫 祈翠語言包 习像章 领袖习澡水 官僚主义 习猪下台 傻大头 习狍 毛魔转世 习特勒 习奥塞斯库、齐奥塞斯库 武汉委托李克强 习背书 两会期间+隐瞒 甩锅侠 毛进平 习二卒 大锅瞻遗 习夶 十一郎习近平 大大品牌 没有网络安全就没有国家安全 禁评大帝 假.."~bang！卒 平话 共哀宗 岿然不动 皇帝亲临忠诚的武汉 彩色熊 民进党 头上三尺有神明 追思焦裕禄 习瘟猪 修宪 乳包文化 习低能儿 巴拿马文件 乳制品 屎禁评 玉习大帝 万岁来武汉 V尼哥 习澳塞斯库 XD 野兽先辈 梁家河 维尼快乐组织（Winnie##Happy##Organization）简称WHO 维尼梗有害 任志强 维持会长 大兔 亲自考察 系包皮 卡近菲 瘟疫降生习近平 习##卡##巴##卡 习呆呆 亲自封号 食腐虫 晚共昏君 习二世胡亥 “梦回大清” Criminal##Xi##"Xitler"##Jinping 拉清单 赵王 习屎黄 翡翠娘娘 习Core 粪坑先生 习二蛋 吸精瓶 支那精神野爹 習敗敗 包经 习流氓 腊肉馅儿包子 东方project 习总 席子兵法 视频看望 中国爱非洲 庆丰废物 赵人13 包包侠 virus##king 习匪帝 Voice##of##Pooh 阿道夫-习 你是反贼吗 恩维尔·霍习 习猪席 毛二世 《生物安全法》 “复辟” 庆丰称帝 口罩外交 䒒(tiáo)菦(qín)苹(píng) 维尼熊给跳跳虎黄牌 二百五大帝 维尼大帝 学包积极分子 新影帝 刁近猴 修宪连任 习尔布特 皇帝梦 不敢高声语 御板泽民 耀眼黄红黄 当皇帝的小丑 共哀宗 祈翠 维尼DISCO 中国首席造梦大师 习核心 撒币宝 人民领袖 塔西佗陷阱 包子露宪 习包子 智商不重要 CoronaXi 习习蛤蛤 中国拉清单工作领导小组组长 现任匪首 习大郎 老歪脖子树 习张三丰 习三拍 满脸喷粪 习奥赛斯库 习条英机 人均接近八千万 习梦思 最后领导人 WHO的君王 闹得欢 重地之战 世界最强乞丐 孤独的毒王 糖尿维尼 “登基” 习宽衣 习教父 习后主 习孢子 尼哥 习大林 外交习语 冰棒外交 蹄防 金科律玉 习包子的Fa 清单帝 崇祯帝 动物之森 赵弹 感恩教育 electron8964 信女愿一生吃素 包子兵法 习太孑 习king 毛泽东2.0 墨索里习 习二二（二零二零年五月二十二日开二会） 裹嘎举吸钢闸门 阳台上的哨兵 二次袁、袁世凯二世、袁二 维尼之声 宽衣帝 nmslese##dream 役民五术 读稿机 习一尊 富平学霸刁斤干 赵付 “黄袍加身” 连专家也为之叹服的电脑天才 支那毒王 习曱甴 习卒习 习卒 吃赵弹 疯狂宇宙包 糟糕皇帝 习壳郎 第22条军规 黑白翠 Heil##Xitler 法外狂徒Lucy（德国） 习时代 SB包子 习王的田野上 法习斯 习和谐 “登机”（与登基同音） 扛麦帝 九评 大海掀翻小池塘 厕所革命 通商宽衣 包子金刚腿 梦回大清 习思想 萨格尔王 尊蛤讨包 人类命运共同体首席架构师 习蛤 沼气专家 那翠化 羽日帝 扛麦郎 NMSL 维尼连任 天安门合法继承人 包包大人 云视察 不同意的举手##没有##没有 游泳一千米 阿平 人民领袖 习博士 讨习檄文 赛禁评 氼兲嫑炛 狙击手待命 昆明湖涨潮 袁世凯第二 书单吟诵者 屎進瓶 戏包皮 习达姆 儿童习典 200吨 习二坐船 普习金 断崖式下跌 习近砰 习武帝 近言 大大招牌 包子宪法 乳透社##小反旗 一天游泳一千米 叩谢习恩 次级乳包 冤大头 恐惊天上人 动森 一带一路 大撒幣 宽衣大帝 包子病毒 刁槑夶尛 腊肉包 Corona##Xi（习病毒） 第一书记王沪宁 仲夏夜之中国梦 专治各种不服 万岁 亲自脱贫 相信有神论的物理学博士 嘻包皮 慨撒大帝 影子末帝 赵家家仆 shit禁评 大国造疫 戏博士 中字头组长 小学居士 习大乞 刁远山 劝进 匪酋习维尼 任大炮 中国离岸隐匿资产管理工作领导小组组组长 指定接班人 贬词包用 集金币 灰习牛 习厉王 总书记来过我的家 毛二习 近身平A 孙笑川 日子像蜜甜 十日文革 总加速师 央视姓党 格萨尔 毛孙 动物庄园 这个年很静 甴种 维稳警察（O） 骑巨龙 非洲大撒币 习贼 叼斤干 中国特色射秽煮疫制度 维尼挂彩 猪禁评 庆丰帝的千秋梦 嬉包皮 The##Xi##Factor（习近平因素） 粪坑兵法 倒车斯基 帝皇頌 颐指气使 川普的朋友or敌人 维尼熊 黄俄 半羽习近平 小学博士 号尿壶公 恩重如删 20000T麦子 野蛮其体魄 包禁评 xdd 不知名氏 国贼习近平 我是一个足球迷 习犬犬 梁家河贵族 刁斤二 习尿瓶 喷粪帝 截颈平 習大佬 習敗北 错误执行者 洗包皮 学包分子 维尼·屎(Winnie##the##Poo) 甴近平 当代秦二世 国王 每日祈翠 吸包皮 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 总统包子习 发皇帝梦 毛二 狙击手待命 青年大学包 习废帝 刁人13 倒车帝 习驴 平&强 习梦撕 动物森友会 Cicada##3301##XD 洗尽贫 迈克尔·索伊 习大 太祖兔 */
package com.pcdd.sonovel.action;

import cn.hutool.core.collection.CollUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.NumberUtil;
import com.pcdd.sonovel.core.Crawler;
import com.pcdd.sonovel.core.Source;
import com.pcdd.sonovel.model.*;
import com.pcdd.sonovel.parse.BookParser;
import com.pcdd.sonovel.parse.SearchParser;
import com.pcdd.sonovel.parse.TocParser;
import com.pcdd.sonovel.util.JsoupUtils;
import lombok.AllArgsConstructor;
import lombok.SneakyThrows;

import java.util.List;
import java.util.Scanner;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * 搜索指定书源
 *
 * @author pcdd
 * Created at 2024/11/10
 */
@AllArgsConstructor
public class SingleSearchAction {

    private final AppConfig config;
    public final Scanner sc = Console.scanner();

    public void downloadFromUrl() {
        Console.print(render("==> 请输入书籍详情页网址: ", "green"));
        String bookUrl = sc.nextLine().strip();
        Rule rule = new Source(config).rule;
        // www.69shuba.me 的链接转换为 69shuba.cx 的
        bookUrl = JsoupUtils.invokeJs(rule.getBook().getUrl(), bookUrl);
        Book book = new BookParser(config).parse(bookUrl);
        SearchResult sr = SearchResult.builder()
                .url(book.getUrl())
                .bookName(book.getBookName())
                .author(book.getAuthor())
                .latestChapter(book.getLatestChapter())
                .lastUpdateTime(book.getLastUpdateTime())
                .build();
        TocParser tocParser = new TocParser(config);
        List<Chapter> toc = tocParser.parse(sr.getUrl());
        // tocParser.shutdown();
        Console.log("<== 《{}》({})，共计 {} 章", sr.getBookName(), sr.getAuthor(), toc.size());
        double res = new Crawler(config).crawl(sr, toc);
        Console.log("<== 完成！总耗时 {} s", NumberUtil.round(res, 2));
    }

    public void downloadByKeyword() {
        // 1. 查询
        Console.print(render("==> 请输入书名或作者（宁少字别错字）: ", "green"));
        String keyword = sc.nextLine().strip();
        if (keyword.isEmpty()) return;
        List<SearchResult> searchResults = new Crawler(config).search(keyword);
        if (CollUtil.isEmpty(searchResults)) {
            return;
        }

        // 2. 打印搜索结果
        new SearchParser(config).printSearchResult(searchResults);

        // 3. 下载
        new DownloadAction(config).execute(searchResults);
    }

    @SneakyThrows
    public void execute() {
        Source source = new Source(config.getSourceId());

        // URL 下载的小说，rule.json 删除 search
        if (source.rule.getSearch() == null) {
            downloadFromUrl();
        } else {
            downloadByKeyword();
        }
    }

}