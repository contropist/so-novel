/* 梁家河 役民五术 庆丰帝的千秋梦 狙击手待命 毛孙 闹得欢 “登基” 维尼警察（X） 赵付 习三点 shit禁评 喷粪帝 共哀宗 扛麦帝 戏博士 习张三丰 通商宽衣 小学博士 刁二将 连专家也为之叹服的电脑天才 习奥赛斯库 隔离”的金葫芦 瘟疫降生习近平 乳制品 野兽先辈 富平学霸刁斤干 习Core 䒒(tiáo)菦(qín)苹(píng) 西朝鲜人民自治岛 习屎黄 维尼史 共哀宗 刁人13 大锅瞻遗 包子宪法 夶 習敗敗 习条英机 颐指气使 总书记来我家 包子露宪 野心习 大大品牌 满脸喷粪 追思焦裕禄 粪坑兵法 习禁评 仲夏夜之中国梦 冠子兵法 黄俄 央视姓党 动物森友会 习包子的Fa 毛二习 大兔 学包率 巴拿马文件 爱新觉罗·近平 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 喜包皮 习贼 独裁国贼 庆丰废物 习语 万岁 称帝修宪 腊肉包 阿平 “习泽东”和“洪宪”（袁世凯的帝号） 读稿机 Mr##Shithole 韦来书记 袭包皮 口罩外交 shuu##kinn##pei A##Big##Deal 世宗 足球外交 花花公子 毛二 刁近猴 川普的朋友or敌人 坡涛汹涌 刁后主 中字头组长 羽日帝 胡志平 毛近平 习二二（二零二零年五月二十二日开二会） 总书记来过我的家 做N届的主席 十一郎习近平 总加速师 维尼熊 200吨 玉习大帝 NMSL 不敢高声语 vop 习二蛋 习二坐船 亲自脱贫 狙击手待命 习式病毒 习大郎 习侯 末代皇帝 赛禁评 习二世胡亥 不同意的举手##没有##没有 近日成 维尼带货 习教父 禁评大帝 武汉委托李克强 习##卡##巴##卡 Criminal##Xi##"Xitler"##Jinping 黑白翠 武统时代 习大林 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 习近砰 支那毒王 席近平 shit##hole##bing##fa WHO的君王 厕所革命 倒车帝 十里山路不换肩 动森 宰相 指定接班人 红二代 SB包子 习二胖 东方project 中国离岸隐匿资产管理工作领导小组组组长 智商不重要 习和谐 崇祯 大撒币 这个年很静 北京中南海支部书记 集近闭 十日文革 小学居士 毛装 刁二婚 不强自息 祈翠語言包 乳包文化 邪大大 添宪宝宝 半羽习近平 头上三尺有神明 万岁来武汉 吸精瓶 坡涛汹涌 吃赵弹 读书单 恩维尔·霍习 习梦思 集金币 扛麦郎 中国的新皇帝 我是一个足球迷 东瘟疫之地统治者暨全境守护者 “登机”（与登基同音） 昆明湖涨潮 720事件 万岁来武汉了 普习金 习梦死 哲欣 战疫国 沼气专家 疯狂宇宙 习猪头 独裁者 那翠化 习厉王 庆丰包·勃列日涅夫 《生物安全法》 任大炮 阳台上的哨兵 親自視頻 nmslese##dream 时间控制 习奥塞斯库、齐奥塞斯库 中国特色射秽煮疫制度 亲自指挥疫情 习总 耀眼黄红黄 electron8964 抗麦套装 格萨尔 第22条军规 外交习语 捐麦子 一天游泳一千米 裸宽包子劾心 颐使气指 乳透社##小反旗 习特勒 嘻包皮 阿道夫-习 刁大犬 影子末帝 洗尽贫 毛魔转世 墨索里习 刁人13 亲自指挥 赵王 习躲躲 习语录 习正日 发皇帝梦 太祖兔 坟头蹦迪 XD 屎禁评 刁槑夶尛 学包积极分子 习壳郎 背书单 卡近菲 习远凸 亲自封号 非洲大撒币 刁远山 包惠帝 习武帝 毛二世 当代秦二世 相信有神论的物理学博士 袁世凯第二 世界最强乞丐 字共狗 习废帝 断崖式下跌 蹄防 习索里尼 祈翠 V尼哥 习宽衣 任志强 朝令夕改 包经 糟糕皇帝 shit侯 习家军 狙击手布阵 细颈瓶 人民战争 习下台 当代秦始皇 习皇帝 孙笑川 近身平A 匪酋习维尼 形式主义防疫 维尼梗有害 习公奭 法习斯 维尼写史 习近平光辉形象 每日祈翠 甴近平 主席+终身制 10号跳跳虎被维尼拉清单 习兵法 萨格尔王 “梦回大清” 重地之战 家业论 你是反贼吗 习奥塞斯库 习王的田野上 骑巨龙 习背书 甴种 支那精神野爹 冲塔 人均接近八千万 习大犬 食腐虫 国王 基拉大和习近平 戏包皮 习付 “黄袍加身” 崇祯帝 孢 战“疫”金句 人民领袖 独彩者 神明论 维尼之声 儿童习典 戴口赵 习包子 洗包皮 中国爱非洲 习包皮 清华毕业 xdd 人类命运共同体首席架构师 virus##king 中国离岸隐匿资产管理工作领导小组组组长 皇帝亲临忠诚的武汉 中国首席造梦大师 彭主席（习主席走了太太接班） 裹嘎举吸钢闸门 云视察 CoronaXi 不知名氏 刁斤二 习达姆 退党 劝进 习二卒 习歪嘴 鞋哥 二百斤 习尽贫 习匪 “皇帝梦” 蔡英文最强助选 习核心 通商宽衣 习流氓 习博士 叼斤干 修宪连任 亲自考察 习大帝 平平 拉清单 新影帝 普近 包包大人 法外狂徒Lucy（德国） 習大佬 习殡法 禁评的理由 最后领导人 恩重如删 习包子 习皇的新装 习曱甴 彩色熊 “复辟” 学包分子 梁家河贵族 口罩大会 翡翠娘娘 百万雄师事件 集金pay 终身领导人 习“甩锅” 动物庄园 习梦撕 疯狂宇宙包 初二圣君 小习微信 习包子 习夶 野兽主席 氼兲嫑炛 皇帝亲临忠诚的武汉 习卒习 包皇 嬉包皮 头号球迷 习emperor 感恩教育 平&强 刁斤山 赵家家仆 吸包皮 20000T麦子 bingbang帝 习king 维尼大帝 次级乳包 假.."~bang！卒 习孢子 总统包子习 习进棺 习尔布特 没规划的葬礼 习蛤 领袖习澡水 公车上书 枪毙名单 贬词包用 梦回大清 二次袁、袁世凯二世、袁二 习太孑 毛进平 屎進瓶 近言 中国拉清单工作领导小组组长 2020全面小康 细瓶颈 糖尿维尼 截颈平 习是春绿 维持会长 白猪 当皇帝的小丑 讨习檄文 习呆呆 皇帝的新衣 人尽皆知的体育迷 五毛主席 文明其精神 野蛮其体魄 386系统驱动游戏 习猪席 纳翠党 大大招牌 撒币宝 号屎洞 亲自删评 親自蒞臨 习犬犬 XDD 二百五大帝 维尼连任 两会期间+隐瞒 維尼頌 包禁评 包子兵法 老歪脖子树 现任匪首 孤独的毒王 第一书记王沪宁 习病法 毛泽东2.0 青年大学包 系包皮 灭共助推器 晚共昏君 疫情蔓延 动物之森 灰习牛 主席贺词 悉包皮 维稳警察（O） 大国造疫 民进党 叩谢习恩 Heil##Xitler Corona##Xi（习病毒） 禁评封号 习得梁家书卷 习澳塞斯库 电脑世代586 九评 大海掀翻小池塘 没有网络安全就没有国家安全 习瘟猪 习习蛤蛤 超邓赶毛 粪坑先生 迈克尔·索伊 信女愿一生吃素 塔西佗陷阱 爱新觉罗近平 皇帝梦 宽衣大帝 习驴 包大人 墙内人 习是春竹 宽衣帝 傻大头 包子病毒 庆丰称帝 官僚主义 Voice##of##Pooh 惜包皮 御板泽民 Adolf##Xitler 清单帝 猪禁评 习后主 尼哥 包子金刚腿 “无罩”现身 习狍 习大乞 游泳一千米 习三拍 维尼DISCO 维尼快乐组织（Winnie##Happy##Organization）简称WHO 甩锅侠 冰棒外交 刁近乎 叩谢习恩 Chairman##Xi 无限连任 老街 清零宗、清零帝 修宪 人民领袖 维尼·屎(Winnie##the##Poo) 习像章 倒车斯基 屎侯 天安门合法继承人 核平全世界 彩色哥 赵弹 九大诉求 专治各种不服 ChinaXi 瘟疫领主习近平 错误执行者 习老八 习卒 腊肉馅儿包子 帝皇頌 习一尊 64岁 包包侠 疯狂宇宙大帝 包帝巡游 习尿瓶 国贼习近平 金科律玉 nmslman（习主席） 习猪下台 岿然不动 赵人13 习思想 号尿壶公 书单吟诵者 武当七侠的政治斗争 红旗下的蛋 大撒幣 The##Xi##Factor（习近平因素） 秦城监狱 習敗北 一带一路 平话 习大 维尼熊给跳跳虎黄牌 尊蛤讨包 日子像蜜甜 习言乱语 北红尾鸲 习低能儿 维尼挂彩 4中组长 习总输记 席子兵法 习匪帝 Cicada##3301##XD 倒车 视频看望 慨撒大帝 送礼平 修宪帝 习时代 冤大头 梦帝 恐惊天上人 */
package com.pcdd.sonovel.core;

import cn.hutool.core.lang.Console;
import cn.hutool.core.lang.Validator;
import cn.hutool.core.util.StrUtil;
import cn.hutool.core.util.URLUtil;
import cn.hutool.http.Header;
import cn.hutool.http.HtmlUtil;
import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import cn.hutool.json.JSONObject;
import cn.hutool.json.JSONUtil;
import com.hankcs.hanlp.HanLP;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.util.RandomUA;
import lombok.experimental.UtilityClass;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;

import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.function.Supplier;
import java.util.stream.Stream;

import static org.jline.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2025/2/6
 */
@UtilityClass
public class CoverUpdater {

    /**
     * 依次尝试不同来源获取封面
     */
    public String fetchCover(Book book, String coverUrl) {
        // 无封面，使用默认封面
        book.setCoverUrl(StrUtil.isEmpty(coverUrl) ? "https://bookcover.yuewen.com/qdbimg/no-cover" : coverUrl);
        if (StrUtil.isEmpty(book.getBookName())) {
            return book.getCoverUrl();
        }
        return Stream.<Supplier<String>>of(
                        () -> fetchQidian(book),
                        () -> fetchZongheng(book),
                        () -> fetchChuangshi(book)
                ).map(Supplier::get)
                .filter(CoverUpdater::isValidCover)
                .findFirst()
                .orElse(book.getCoverUrl());
    }

    /**
     * 起点中文网
     */
    public String fetchQidian(Book book) {
        Map<String, String> headers = new LinkedHashMap<>();
        headers.put(Header.USER_AGENT.getValue(), RandomUA.generate());
        headers.put(Header.COOKIE.getValue(), "w_tsfp=ltvgWVEE2utBvS0Q6KvtkkmvETw7Z2R7xFw0D+M9Os09AacnUJyD145+vdfldCyCt5Mxutrd9MVxYnGAUtAnfxcSTciYb5tH1VPHx8NlntdKRQJtA5qJW1Qbd7J2umNBLW5YI0blj2ovIoFAybBoiVtZuyJ137ZlCa8hbMFbixsAqOPFm/97DxvSliPXAHGHM3wLc+6C6rgv8LlSgXyD8FmNOVlxdr9X0kCb1T0dC3FW9BO+AexINxmkKtutXZxDuDH2tz/iaJWl0QMh5FlBpRw4d9Lh2zC7JmNGJXkaewD23+I2Z7z6ZLh6+2xIAL5FW1kVqQ8ZteI5+URPDSi9YHWPBfp6tQAARvJZ/82seSvFxIb+c1AMu4Zt0AYlsYAN6DEjYTimKd8JSWTLNnUGfotRbsq+NHlkAkBbX2RE5Qdb;");

        try {
            HttpResponse resp = HttpRequest.get(StrUtil.format("https://www.qidian.com/so/{}.html", book.getBookName()))
                    .headerMap(headers, true)
                    .execute();
            Document document = Jsoup.parse(resp.body());
            resp.close();

            for (Element e : document.select(".res-book-item")) {
                String qdName = e.select(".book-mid-info > .book-info-title > a").text();
                // 起点作家
                String qdAuthor1 = e.select(".book-mid-info > .author > .name").text();
                // 非起点作家
                String qdAuthor2 = e.select(".book-mid-info > .author > i").text();
                String qdAuthor = StrUtil.isEmpty(qdAuthor1) ? qdAuthor2 : qdAuthor1;

                if (matchBook(book, qdName, qdAuthor)) {
                    return URLUtil.normalize(e.select(".book-img-box > a > img").attr("src"))
                            .replaceAll("/150(\\.webp)?", "");
                }
            }
        } catch (Exception e) {
            Console.error(render("获取起点封面失败：{}", e.getMessage(), "red"));
        }
        return null;
    }

    /**
     * 纵横中文网
     */
    public String fetchZongheng(Book book) {
        try {
            String url = "https://search.zongheng.com/search/book";
            // 自动拼接查询字符串
            Map<String, Object> params = new HashMap<>();
            params.put("keyword", book.getBookName());
            params.put("pageNo", 1);
            params.put("pageNum", 20);
            params.put("isFromHuayu", 0);

            HttpRequest req = HttpRequest.get(url)
                    .form(params)
                    .header(Header.USER_AGENT, RandomUA.generate());
            HttpResponse resp = req.execute();
            String body = resp.body();
            JSONObject datasField = JSONUtil.parseObj(body)
                    .getJSONObject("data")
                    .getJSONObject("datas");

            // 搜索结果未空
            if (datasField == null) {
                return null;
            }

            for (Object o : datasField.getJSONArray("list")) {
                JSONObject bookObj = (JSONObject) o;
                if (matchBook(book, bookObj.getStr("name"), bookObj.getStr("authorName"))) {
                    return "https://static.zongheng.com/upload" + bookObj.getStr("coverUrl");
                }
            }

            resp.close();
        } catch (Exception e) {
            Console.error(e);
            return null;
        }

        return null;
    }

    /**
     * 创世中文网
     */
    public String fetchChuangshi(Book book) {
        return null;
    }

    private boolean matchBook(Book book, String name, String author) {
        String sourceName = HanLP.convertToSimplifiedChinese(book.getBookName());
        String sourceAuthor = HanLP.convertToSimplifiedChinese(book.getAuthor());
        name = HtmlUtil.cleanHtmlTag(name);
        author = HtmlUtil.cleanHtmlTag(author);
        return StrUtil.equals(sourceName, name) && StrUtil.equals(sourceAuthor, author);
    }

    private boolean isValidCover(String coverUrl) {
        return StrUtil.isNotBlank(coverUrl) && Validator.isUrl(coverUrl);
    }

}