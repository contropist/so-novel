/* 20000T麦子 世宗 独彩者 中国拉清单工作领导小组组长 习匪 习老八 习包皮 西朝鲜人民自治岛 习屎黄 你是反贼吗 倒车 亲自指挥 儿童习典 人尽皆知的体育迷 梦回大清 习近平光辉形象 北红尾鸲 添宪宝宝 毛二习 恩维尔·霍习 彩色熊 习猪下台 慨撒大帝 形式主义防疫 习王的田野上 习条英机 习大 超邓赶毛 刁斤二 习特勒 万岁来武汉 傻大头 Mr##Shithole 劝进 甴种 包子露宪 习家军 维尼熊 毛二世 食腐虫 维尼大帝 修宪 文明其精神 疫情蔓延 戴口赵 集近闭 习emperor 二百五大帝 十里山路不换肩 恩重如删 中字头组长 习梦撕 大大招牌 习奥塞斯库、齐奥塞斯库 习禁评 包子兵法 万岁 修宪帝 叩谢习恩 亲自指挥疫情 当代秦二世 “黄袍加身” 修宪连任 包禁评 习梦死 捐麦子 晚共昏君 孢 10号跳跳虎被维尼拉清单 通商宽衣 瘟疫领主习近平 满脸喷粪 习付 叩谢习恩 习二二（二零二零年五月二十二日开二会） 天安门合法继承人 五毛主席 包包侠 习是春绿 坡涛汹涌 匪酋习维尼 庆丰称帝 亲自脱贫 “梦回大清” 刁近猴 刁二婚 阿道夫-习 外交习语 祈翠語言包 冰棒外交 赛禁评 指定接班人 维尼挂彩 半羽习近平 东瘟疫之地统治者暨全境守护者 习奥赛斯库 习得梁家书卷 云视察 吃赵弹 人均接近八千万 Voice##of##Pooh 不知名氏 万岁来武汉了 包帝巡游 人民战争 中国离岸隐匿资产管理工作领导小组组组长 野兽先辈 阿平 維尼頌 习“甩锅” 御板泽民 2020全面小康 习瘟猪 习犬犬 大大品牌 足球外交 影子末帝 吸包皮 习卒 疯狂宇宙大帝 皇帝的新衣 习king 中国首席造梦大师 哲欣 称帝修宪 玉习大帝 末代皇帝 习Core 基拉大和习近平 主席+终身制 翡翠娘娘 习时代 亲自封号 九大诉求 庆丰帝的千秋梦 氼兲嫑炛 口罩外交 神明论 习二卒 习总 親自視頻 孤独的毒王 系包皮 没有网络安全就没有国家安全 彩色哥 扛麦帝 送礼平 爱新觉罗近平 胡志平 The##Xi##Factor（习近平因素） 支那精神野爹 邪大大 习二蛋 红旗下的蛋 富平学霸刁斤干 格萨尔 维尼连任 字共狗 退党 V尼哥 乳透社##小反旗 习下台 禁评封号 厕所革命 nmslman（习主席） 小学居士 耀眼黄红黄 这个年很静 野兽主席 骑巨龙 人类命运共同体首席架构师 蔡英文最强助选 初二圣君 习歪嘴 毛魔转世 读稿机 书单吟诵者 喜包皮 习流氓 每日祈翠 乳包文化 冠子兵法 野蛮其体魄 任大炮 习病法 恐惊天上人 当皇帝的小丑 疯狂宇宙包 shit禁评 包包大人 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 阳台上的哨兵 200吨 朝令夕改 习二坐船 喷粪帝 那翠化 相信有神论的物理学博士 清单帝 习博士 4中组长 宽衣大帝 习远凸 梦帝 virus##king 发皇帝梦 毛进平 官僚主义 席子兵法 刁后主 读书单 灰习牛 毛装 习三拍 习孢子 集金币 赵家家仆 习近砰 SB包子 仲夏夜之中国梦 感恩教育 颐指气使 习像章 NMSL 近言 羽日帝 皇帝亲临忠诚的武汉 倒车斯基 “复辟” 梁家河 习张三丰 习兵法 萨格尔王 袭包皮 习进棺 两会期间+隐瞒 人民领袖 Cicada##3301##XD 习大犬 讨习檄文 专治各种不服 习猪席 视频看望 习一尊 糟糕皇帝 红二代 维尼警察（X） 中国特色射秽煮疫制度 包大人 屎禁评 纳翠党 習敗北 庆丰废物 习思想 习低能儿 瘟疫降生习近平 WHO的君王 XD 习式病毒 宽衣帝 抗麦套装 时间控制 《生物安全法》 坡涛汹涌 总书记来我家 动森 普习金 现任匪首 洗包皮 刁人13 习殡法 习是春竹 无限连任 大锅瞻遗 中国爱非洲 “习泽东”和“洪宪”（袁世凯的帝号） 狙击手布阵 迈克尔·索伊 习呆呆 习索里尼 贬词包用 64岁 塔西佗陷阱 席近平 十一郎习近平 韦来书记 乳制品 习包子 法外狂徒Lucy（德国） 次级乳包 甩锅侠 习贼 灭共助推器 禁评大帝 习核心 细颈瓶 游泳一千米 戏包皮 领袖习澡水 东方project 386系统驱动游戏 猪禁评 皇帝亲临忠诚的武汉 冲塔 甴近平 习武帝 连专家也为之叹服的电脑天才 维尼·屎(Winnie##the##Poo) bingbang帝 䒒(tiáo)菦(qín)苹(píng) 孙笑川 习大林 维尼DISCO 皇帝梦 共哀宗 习语录 中国离岸隐匿资产管理工作领导小组组组长 维尼写史 习达姆 习曱甴 习正日 习壳郎 一天游泳一千米 细瓶颈 我是一个足球迷 糖尿维尼 Criminal##Xi##"Xitler"##Jinping 独裁者 平&强 终身领导人 大撒币 Chairman##Xi 独裁国贼 刁近乎 习语 裸宽包子劾心 习二世胡亥 崇祯 颐使气指 号尿壶公 狙击手待命 “登基” shuu##kinn##pei 人民领袖 悉包皮 错误执行者 口罩大会 法习斯 宰相 公车上书 习奥塞斯库 粪坑兵法 大撒幣 维稳警察（O） Heil##Xitler “登机”（与登基同音） 中国的新皇帝 习教父 习公奭 彭主席（习主席走了太太接班） 包子宪法 维尼熊给跳跳虎黄牌 第一书记王沪宁 隔离”的金葫芦 断崖式下跌 岿然不动 720事件 冤大头 花花公子 动物庄园 维尼之声 巴拿马文件 没规划的葬礼 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 xdd 任志强 习大乞 十日文革 截颈平 赵弹 民进党 尼哥 动物之森 帝皇頌 亲自考察 非洲大撒币 武当七侠的政治斗争 太祖兔 百万雄师事件 二次袁、袁世凯二世、袁二 亲自删评 扛麦郎 尊蛤讨包 shit##hole##bing##fa 墙内人 梁家河贵族 第22条军规 枪毙名单 习包子 当代秦始皇 武汉委托李克强 习言乱语 吸精瓶 祈翠 黑白翠 崇祯帝 Corona##Xi（习病毒） 爱新觉罗·近平 动物森友会 信女愿一生吃素 习驴 XDD 战“疫”金句 老歪脖子树 野心习 役民五术 总书记来过我的家 习厉王 习二胖 习包子的Fa A##Big##Deal 习大郎 家业论 粪坑先生 国王 狙击手待命 蹄防 日子像蜜甜 親自蒞臨 通商宽衣 学包分子 维尼快乐组织（Winnie##Happy##Organization）简称WHO 总统包子习 近身平A 卡近菲 包皇 秦城监狱 裹嘎举吸钢闸门 刁大犬 习和谐 总加速师 习习蛤蛤 战疫国 ChinaXi 北京中南海支部书记 包经 nmslese##dream 不强自息 新影帝 小学博士 庆丰包·勃列日涅夫 Adolf##Xitler 腊肉包 习皇的新装 “皇帝梦” 大海掀翻小池塘 做N届的主席 金科律玉 学包积极分子 包子金刚腿 老街 智商不重要 不敢高声语 维持会长 普近 主席贺词 习蛤 假.."~bang！卒 背书单 习梦思 学包率 习夶 习后主 世界最强乞丐 CoronaXi 習敗敗 沼气专家 “无罩”现身 vop 习总输记 嘻包皮 包子病毒 习猪头 习皇帝 习##卡##巴##卡 毛二 九评 习尿瓶 国贼习近平 川普的朋友or敌人 習大佬 赵付 刁人13 一带一路 戏博士 刁斤山 昆明湖涨潮 习尽贫 习三点 平话 习躲躲 习废帝 号屎洞 夶 维尼带货 疯狂宇宙 黄俄 二百斤 叼斤干 习卒习 追思焦裕禄 武统时代 墨索里习 刁远山 电脑世代586 维尼史 习狍 习匪帝 清零宗、清零帝 共哀宗 重地之战 近日成 拉清单 毛近平 习背书 青年大学包 央视姓党 鞋哥 不同意的举手##没有##没有 习澳塞斯库 毛孙 习包子 毛泽东2.0 维尼梗有害 屎侯 头上三尺有神明 闹得欢 shit侯 小习微信 最后领导人 刁二将 白猪 支那毒王 大国造疫 倒车帝 头号球迷 嬉包皮 腊肉馅儿包子 包惠帝 惜包皮 坟头蹦迪 赵王 习尔布特 electron8964 集金pay 核平全世界 平平 刁槑夶尛 习太孑 清华毕业 袁世凯第二 撒币宝 大兔 洗尽贫 习宽衣 屎進瓶 习侯 习大帝 赵人13 禁评的理由 */
package com.pcdd.sonovel.core;

import cn.hutool.core.date.StopWatch;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.lang.Console;
import cn.hutool.core.util.NumberUtil;
import com.pcdd.sonovel.handle.CrawlerPostHandler;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Book;
import com.pcdd.sonovel.model.Chapter;
import com.pcdd.sonovel.model.SearchResult;
import com.pcdd.sonovel.parse.BookParser;
import com.pcdd.sonovel.parse.ChapterParser;
import com.pcdd.sonovel.parse.SearchParser;
import com.pcdd.sonovel.parse.SearchParser6;
import com.pcdd.sonovel.util.FileUtils;
import lombok.SneakyThrows;

import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import static org.fusesource.jansi.AnsiRenderer.render;

/**
 * @author pcdd
 * Created at 2021/6/10
 */
public class Crawler {

    private final AppConfig config;
    private String bookDir;

    public Crawler(AppConfig config) {
        this.config = config;
    }

    /**
     * 搜索小说
     *
     * @param keyword 关键字
     * @return 匹配的小说列表
     */
    public List<SearchResult> search(String keyword) {
        Console.log("<== 正在搜索...");
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();

        List<SearchResult> searchResults;

        if (config.getSourceId() == 6) {
            searchResults = new SearchParser6(config).parse(keyword);
        } else {
            searchResults = new SearchParser(config).parse(keyword, true);
        }

        stopWatch.stop();
        Console.log("<== 搜索到 {} 条记录，耗时 {} s", searchResults.size(), NumberUtil.round(stopWatch.getTotalTimeSeconds(), 2));

        return searchResults;
    }

    /**
     * 爬取小说
     *
     * @param sr  小说详情
     * @param toc 小说目录
     */
    @SneakyThrows
    public double crawl(SearchResult sr, List<Chapter> toc) {
        // 小说详情页url
        String url = sr.getUrl();
        String bookName = sr.getBookName();
        String author = sr.getAuthor();
        Book book = new BookParser(config).parse(url);

        // 下载临时目录名格式：书名(作者) EXT
        bookDir = FileUtils.sanitizeFileName("%s(%s) %s".formatted(bookName, author, config.getExtName().toUpperCase()));
        // 必须 new File()，否则无法使用 . 和 ..
        File dir = FileUtil.mkdir(new File(config.getDownloadPath() + File.separator + bookDir));
        if (!dir.exists()) {
            // C:\Program Files 下创建需要管理员权限
            Console.log(render("""
                    创建下载目录失败：%s
                    1. 检查 config.ini 下载路径是否合法
                    2. 尝试以管理员身份运行（部分目录需要管理员权限）
                    """.formatted(dir), "red"));
            return 0;
        }

        int autoThreads = config.getThreads() == -1 ? Runtime.getRuntime().availableProcessors() * 2 : config.getThreads();
        // 创建线程池
        ExecutorService executor = Executors.newFixedThreadPool(autoThreads);
        // 阻塞主线程，用于计时
        CountDownLatch latch = new CountDownLatch(toc.size());

        Console.log("<== 开始下载《{}》（{}） 共计 {} 章 | 线程数：{}", bookName, author, toc.size(), autoThreads);
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        ChapterParser chapterParser = new ChapterParser(config);
        // 爬取&下载章节
        toc.forEach(item -> executor.execute(() -> {
            createChapterFile(chapterParser.parse(item, latch, sr));
            Console.log("<== 待下载章节数：{}", latch.getCount());
        }));

        // 阻塞主线程，等待章节全部下载完毕
        latch.await();
        executor.shutdown();
        new CrawlerPostHandler(config).handle(book, dir);
        stopWatch.stop();

        return stopWatch.getTotalTimeSeconds();
    }

    /**
     * 保存章节
     */
    private void createChapterFile(Chapter chapter) {
        if (chapter == null) return;

        try (OutputStream fos = new BufferedOutputStream(new FileOutputStream(generateChapterPath(chapter)))) {
            fos.write(chapter.getContent().getBytes(StandardCharsets.UTF_8));
        } catch (Exception e) {
            Console.error(e);
        }
    }

    private String generateChapterPath(Chapter chapter) {
        String parentPath = config.getDownloadPath() + File.separator + bookDir + File.separator;

        return parentPath + chapter.getOrder() + switch (config.getExtName()) {
            case "html" -> "_.html";
            case "txt" -> "_" + FileUtils.sanitizeFileName(chapter.getTitle()) + ".txt";
            // 转换前的格式为 html
            case "epub", "pdf" -> "_" + FileUtils.sanitizeFileName(chapter.getTitle()) + ".html";
            default -> throw new IllegalStateException("暂不支持的下载格式: " + config.getExtName());
        };
    }

}