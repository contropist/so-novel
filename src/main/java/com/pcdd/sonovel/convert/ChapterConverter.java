/* 維尼頌 習大佬 习猪席 最后领导人 习王的田野上 Criminal##Xi##"Xitler"##Jinping 东方project 疯狂宇宙 初二圣君 XDD 习流氓 习包子的Fa nmslman（习主席） 梁家河贵族 崇祯帝 禁评的理由 耀眼黄红黄 维尼带货 游泳一千米 维尼熊 大撒币 习大帝 戏包皮 二次袁、袁世凯二世、袁二 电脑世代586 国贼习近平 相信有神论的物理学博士 包子兵法 两会期间+隐瞒 法外狂徒Lucy（德国） 赵人13 九大诉求 共哀宗 昆明湖涨潮 习包子 毛近平 普习金 WHO的君王 彩色熊 习一尊 断崖式下跌 终身领导人 甴种 法习斯 扛麦郎 重地之战 习禁评 习澳塞斯库 糟糕皇帝 习达姆 Heil##Xitler 惜包皮 习背书 The##Xi##Factor（习近平因素） 仲夏夜之中国梦 习后主 习包子 倒车帝 中国首席造梦大师 Voice##of##Pooh 皇帝梦 九评 NMSL 毛进平 习尔布特 不敢高声语 羽日帝 西朝鲜人民自治岛 Chairman##Xi 皇帝亲临忠诚的武汉 习是春竹 感恩教育 云视察 刁大犬 乳制品 塔西佗陷阱 “无罩”现身 刁后主 那翠化 习“甩锅” 信女愿一生吃素 不强自息 亲自指挥 “登机”（与登基同音） 通商宽衣 形式主义防疫 我是一个足球迷 冠子兵法 人尽皆知的体育迷 支那毒王 主席贺词 小学居士 韦来书记 386系统驱动游戏 维尼梗有害 维尼DISCO 习二蛋 二百五大帝 习思想 总书记来我家 青年大学包 现任匪首 小学博士 習敗敗 “皇帝梦” “黄袍加身” 口罩外交 新影帝 维稳警察（O） 庆丰废物 习条英机 习二世胡亥 傻大头 号屎洞 习语 民进党 武汉委托李克强 厕所革命 悉包皮 习特勒 贬词包用 vop 习二胖 毛孙 万岁来武汉 瘟疫领主习近平 猪禁评 北京中南海支部书记 习卒 次级乳包 2020全面小康 央视姓党 包帝巡游 近身平A 细瓶颈 国王 颐使气指 甴近平 习奥赛斯库 习梦死 哲欣 庆丰包·勃列日涅夫 时间控制 梦回大清 习总 习太孑 大国造疫 彩色哥 蹄防 独裁者 乳透社##小反旗 习瘟猪 文明其精神 添宪宝宝 中国的新皇帝 习二二（二零二零年五月二十二日开二会） 夶 狙击手待命 亲自脱贫 赵家家仆 大大品牌 二百斤 当代秦始皇 习近砰 卡近菲 习大林 百万雄师事件 帝皇頌 劝进 一天游泳一千米 足球外交 赵弹 习言乱语 隔离”的金葫芦 超邓赶毛 维尼快乐组织（Winnie##Happy##Organization）简称WHO 讨习檄文 指定接班人 梁家河 腊肉馅儿包子 彭主席（习主席走了太太接班） 阿平 大兔 天安门合法继承人 习夶 萨格尔王 朝令夕改 倒车斯基 shuu##kinn##pei 习习蛤蛤 这个年很静 黄俄 包子宪法 十日文革 刁人13 系包皮 野心习 倒车 清零宗、清零帝 近日成 动物庄园 闹得欢 200吨 禁评大帝 习公奭 氼兲嫑炛 屎禁评 习king 习奥塞斯库、齐奥塞斯库 裸宽包子劾心 中国特色射秽煮疫制度 退党 V尼哥 日子像蜜甜 包惠帝 玉习大帝 刁槑夶尛 颐指气使 平平 狙击手布阵 武统时代 习包皮 末代皇帝 主席+终身制 習敗北 人类命运共同体首席架构师 爱新觉罗·近平 御板泽民 总统包子习 习厉王 粪坑兵法 学包积极分子 糖尿维尼 习猪头 喜包皮 习张三丰 公车上书 习驴 战“疫”金句 学包分子 川普的朋友or敌人 包包侠 毛装 习索里尼 无限连任 集近闭 共哀宗 胡志平 叩谢习恩 世界最强乞丐 通商宽衣 《生物安全法》 维尼挂彩 影子末帝 总加速师 号尿壶公 半羽习近平 习屎黄 读稿机 满脸喷粪 习二卒 习下台 翡翠娘娘 吸精瓶 袁世凯第二 习犬犬 第22条军规 尼哥 孙笑川 捐麦子 儿童习典 shit禁评 书单吟诵者 xdd 习老八 包皇 Cicada##3301##XD 核平全世界 习壳郎 拉清单 金科律玉 习正日 蔡英文最强助选 嘻包皮 大撒幣 禁评封号 宰相 祈翠 吸包皮 4中组长 太祖兔 叼斤干 习低能儿 黑白翠 梦帝 大海掀翻小池塘 “习泽东”和“洪宪”（袁世凯的帝号） 刁人13 清华毕业 粪坑先生 洗尽贫 习三拍 刁近乎 万岁 屎進瓶 中国拉清单工作领导小组组长 冲塔 爱新觉罗近平 袭包皮 人民战争 动森 皇帝亲临忠诚的武汉 戏博士 当代秦二世 连专家也为之叹服的电脑天才 赛禁评 神明论 独彩者 十一郎习近平 习教父 A##Big##Deal 坡涛汹涌 中国离岸隐匿资产管理工作领导小组组组长 尊蛤讨包 毛二习 习蛤 乳包文化 刁近猴 nmslese##dream 野兽先辈 不同意的举手##没有##没有 枪毙名单 口罩大会 维尼之声 恩重如删 习卒习 习匪帝 每日祈翠 720事件 官僚主义 习博士 Adolf##Xitler 第一书记王沪宁 维尼·屎(Winnie##the##Poo) 巴拿马文件 中字头组长 习侯 灭共助推器 野蛮其体魄 bingbang帝 习时代 秦城监狱 习是春绿 富平学霸刁斤干 十里山路不换肩 坡涛汹涌 shit侯 头上三尺有神明 习近平光辉形象 视频看望 毛二 维持会长 习尽贫 习##卡##巴##卡 习总输记 修宪 追思焦裕禄 不知名氏 老歪脖子树 人均接近八千万 腊肉包 赵付 习像章 支那精神野爹 动物森友会 习二坐船 孤独的毒王 狙击手待命 冤大头 习病法 习尿瓶 平话 习匪 ChinaXi 截颈平 习宽衣 习殡法 习大郎 红二代 习武帝 撒币宝 平&强 习大乞 小习微信 孢 刁二婚 格萨尔 10号跳跳虎被维尼拉清单 习呆呆 习emperor 发皇帝梦 习兵法 习贼 晚共昏君 习语录 该违禁词汇由 GitCode 官方生成，仅用于测试，请勿传播！ 外交习语 恐惊天上人 习奥塞斯库 刁二将 宽衣撸绣单肩扛麦光腚拉碾歪脖撒币小学博士帝 当皇帝的小丑 假.."~bang！卒 SB包子 错误执行者 集金币 shit##hole##bing##fa 席近平 习大 甩锅侠 屎侯 没规划的葬礼 骑巨龙 疯狂宇宙包 野兽主席 包子露宪 基拉大和习近平 包经 习付 親自蒞臨 习梦撕 维尼大帝 吃赵弹 坟头蹦迪 非洲大撒币 习曱甴 恩维尔·霍习 CoronaXi 普近 毛二世 领袖习澡水 习远凸 东瘟疫之地统治者暨全境守护者 专治各种不服 清单帝 庆丰称帝 大大招牌 迈克尔·索伊 喷粪帝 修宪连任 刁远山 疫情蔓延 疯狂宇宙大帝 “复辟” 习皇的新装 慨撒大帝 红旗下的蛋 读书单 习包子 习孢子 “登基” 维尼写史 头号球迷 总书记来过我的家 墨索里习 扛麦帝 修宪帝 你是反贼吗 没有网络安全就没有国家安全 花花公子 称帝修宪 裹嘎举吸钢闸门 习式病毒 叩谢习恩 匪酋习维尼 习三点 习梦思 刁斤山 中国离岸隐匿资产管理工作领导小组组组长 习家军 智商不重要 武当七侠的政治斗争 食腐虫 任大炮 一带一路 近言 毛泽东2.0 送礼平 北红尾鸲 维尼警察（X） 亲自删评 洗包皮 electron8964 墙内人 嬉包皮 䒒(tiáo)菦(qín)苹(píng) 动物之森 赵王 沼气专家 祈翠語言包 老街 包禁评 灰习牛 五毛主席 习进棺 万岁来武汉了 Mr##Shithole 战疫国 人民领袖 亲自封号 抗麦套装 阳台上的哨兵 20000T麦子 刁斤二 维尼熊给跳跳虎黄牌 瘟疫降生习近平 大锅瞻遗 习狍 包子金刚腿 virus##king 亲自考察 戴口赵 习猪下台 毛魔转世 维尼连任 习核心 纳翠党 习皇帝 Corona##Xi（习病毒） 维尼史 家业论 64岁 独裁国贼 集金pay 习废帝 世宗 宽衣帝 阿道夫-习 中国爱非洲 做N届的主席 人民领袖 皇帝的新衣 役民五术 XD 背书单 崇祯 鞋哥 习和谐 习歪嘴 冰棒外交 习得梁家书卷 邪大大 白猪 字共狗 亲自指挥疫情 习Core 细颈瓶 习躲躲 包大人 “梦回大清” 学包率 任志强 庆丰帝的千秋梦 包子病毒 包包大人 席子兵法 习大犬 宽衣大帝 親自視頻 岿然不动 */
package com.pcdd.sonovel.convert;

import cn.hutool.core.util.StrUtil;
import cn.hutool.extra.template.Template;
import cn.hutool.extra.template.TemplateConfig;
import cn.hutool.extra.template.TemplateEngine;
import cn.hutool.extra.template.TemplateUtil;
import com.pcdd.sonovel.core.ChapterFilter;
import com.pcdd.sonovel.core.ChapterFormatter;
import com.pcdd.sonovel.model.AppConfig;
import com.pcdd.sonovel.model.Chapter;
import lombok.AllArgsConstructor;

import java.util.HashMap;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;


/**
 * @author pcdd
 * Created at 2024/3/17
 */
@AllArgsConstructor
public class ChapterConverter {

    private final AppConfig config;
    private final TemplateEngine engine = TemplateUtil.createEngine(new TemplateConfig("templates", TemplateConfig.ResourceMode.CLASSPATH));

    public Chapter convert(Chapter chapter) {
        String extName = config.getExtName();
        String filteredContent = new ChapterFilter(config).filter(chapter);
        String content = new ChapterFormatter(config).format(filteredContent);

        if ("txt".equals(extName)) {
            // 全角空格，用于首行缩进
            String ident = "\u3000".repeat(2);
            Matcher matcher = Pattern.compile("<p>(.*?)</p>").matcher(content);
            StringBuilder result = new StringBuilder();

            while (matcher.find()) {
                result.append(ident)
                        .append(matcher.group(1))
                        .append("\n");
            }

            content = chapter.getTitle() + "\n".repeat(2) + result;
        }
        if (extName.matches("(?i)^(epub|html|pdf)$")) {
            chapter.setContent(content);
            content = templateRender(chapter, extName);
        }

        chapter.setContent(content);
        return chapter;
    }

    /**
     * 根据扩展名渲染对应模板
     */
    private String templateRender(Chapter chapter, String extName) {
        // epub 或 html 模板
        Template template = engine.getTemplate(StrUtil.format("chapter_{}.flt", extName));
        Map<String, String> map = new HashMap<>();
        map.put("title", chapter.getTitle());
        map.put("content", chapter.getContent());

        return template.render(map);
    }

}